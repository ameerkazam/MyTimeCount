<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="mainTitle">نظام الإدارة المتكامل 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Firebase Core -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <style>
        /* ================================================ */
        /* تعريف الثيمات والمتغيرات الأساسية */
        /* ================================================ */
        :root { 
            --p: #3b82f6; --s: #10b981; --d: #ef4444; --w: #f59e0b; 
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --border: #334155; --inp-bg: #0f172a;
            --glow: rgba(59, 130, 246, 0.5);
            --header-height: 70px;
            --footer-height: 80px;
            --gradient-primary: linear-gradient(135deg, #3b82f6, #8b5cf6);
            --gradient-success: linear-gradient(135deg, #10b981, #059669);
            --gradient-warning: linear-gradient(135deg, #f59e0b, #d97706);
            --gradient-danger: linear-gradient(135deg, #ef4444, #dc2626);
            --gradient-purple: linear-gradient(135deg, #8b5cf6, #6366f1);
            --gradient-pink: linear-gradient(135deg, #ec4899, #f43f5e);
        }
        [data-theme="light"] {
            --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --border: #e2e8f0; --inp-bg: #f8fafc;
            --glow: rgba(59, 130, 246, 0.2);
        }
        [data-theme="midnight"] {
            --bg: #020617; --card: #1e1b4b; --text: #e0e7ff; --border: #312e81; --inp-bg: #0f172a;
            --p: #6366f1; --glow: rgba(99, 102, 241, 0.5);
        }
        [data-theme="royal"] {
            --bg: #2e1065; --card: #4c1d95; --text: #f5f3ff; --border: #6d28d9; --inp-bg: #2e1065;
            --p: #a855f7; --s: #22c55e; --glow: rgba(168, 85, 247, 0.5);
        }
        [data-theme="forest"] {
            --bg: #064e3b; --card: #065f46; --text: #ecfdf5; --border: #047857; --inp-bg: #064e3b;
            --p: #10b981; --s: #facc15; --glow: rgba(16, 185, 129, 0.5);
        }

        * { 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, system-ui, sans-serif; 
            transition: background-color 0.3s ease, color 0.2s ease, border-color 0.2s;
            margin: 0;
            padding: 0;
        }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            position: relative;
        }

        /* تحميل متحرك محسن */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--card) 25%, var(--border) 50%, var(--card) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
            height: 40px;
            margin: 10px 0;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        .shimmer-loading {
            background: linear-gradient(90deg, 
                var(--card) 0%, 
                var(--border) 30%, 
                var(--card) 60%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        /* انتقال الصفحات */
        .page-transition {
            animation: pageEnter 0.3s ease;
        }

        @keyframes pageEnter {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* تحسين حقول الإدخال */
        .form-floating {
            position: relative;
            margin-bottom: 20px;
        }

        .form-floating input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--inp-bg);
            color: var(--text);
            transition: 0.3s;
            font-size: 16px;
        }

        .form-floating input:focus {
            border-color: var(--p);
            box-shadow: 0 0 0 3px var(--glow);
            outline: none;
        }

        .form-floating label {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--card);
            padding: 0 8px;
            color: #94a3b8;
            transition: 0.3s;
            pointer-events: none;
        }

        .form-floating input:focus + label,
        .form-floating input:not(:placeholder-shown) + label {
            top: 0;
            font-size: 12px;
            color: var(--p);
        }

        /* نظام الإشعارات المحسن */
        .toast-container { 
            position: fixed; 
            top: 80px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 9999; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            width: 90%; 
            max-width: 350px; 
            pointer-events: none;
        }
        .toast { 
            background: var(--card); 
            color: var(--text); 
            padding: 16px 20px; 
            border-radius: 16px; 
            border-right: 6px solid var(--p); 
            box-shadow: 0 20px 35px rgba(0,0,0,0.3); 
            animation: slideInToast 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
            font-weight: 600; 
            font-size: 14px; 
            border: 1px solid var(--border); 
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: auto;
        }
        @keyframes slideInToast { 
            from { transform: translateY(-150%) scale(0.8); opacity: 0; } 
            to { transform: translateY(0) scale(1); opacity: 1; } 
        }

        .announcement-bar {
            background: linear-gradient(90deg, var(--p), var(--s));
            color: white;
            padding: 14px 20px;
            text-align: center;
            font-weight: bold;
            font-size: 15px;
            display: none;
            animation: slideDown 0.5s ease;
            border-bottom: 2px solid rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1400;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        /* الشريط العلوي الرئيسي */
        .top-taskbar {
            position: sticky;
            top: 0;
            z-index: 1500;
            background: var(--card);
            backdrop-filter: blur(15px);
            border-bottom: 2px solid var(--border);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            height: var(--header-height);
        }

        .cloud-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: bold;
            border: 1px solid var(--border);
            background: var(--inp-bg);
            backdrop-filter: blur(5px);
        }
        .cloud-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transition: all 0.3s;
        }
        .cloud-online { background: #10b981; box-shadow: 0 0 12px #10b981; animation: pulseOnline 2s infinite; }
        .cloud-offline { background: #ef4444; box-shadow: 0 0 12px #ef4444; }
        .cloud-syncing { background: #f59e0b; animation: pulseSync 1s infinite; }

        @keyframes pulseOnline {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .icon-btn-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .icon-btn {
            background: var(--inp-bg);
            border: 1px solid var(--border);
            color: var(--text);
            width: 45px;
            height: 45px;
            border-radius: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .icon-btn:hover {
            border-color: var(--p);
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        .icon-btn:active {
            transform: scale(0.95);
        }
        .logout-btn {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid var(--d);
            color: var(--d);
            width: 45px;
            height: 45px;
            border-radius: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transition: 0.3s;
        }
        .logout-btn:hover {
            background: var(--d);
            color: white;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 0 20px var(--d);
        }

        /* شاشات تسجيل الدخول */
        #loginScreen, #registerScreen, #firstAdminScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            padding: 15px;
        }
        .login-box {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(15px);
            padding: 35px 25px;
            border-radius: 35px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 30px 50px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeInScale 0.6s ease;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .login-box h2 {
            margin-bottom: 25px;
            color: var(--text);
            font-size: 28px;
        }
        .login-input {
            width: 100%;
            padding: 16px;
            margin: 10px 0;
            border-radius: 18px;
            border: 1px solid var(--border);
            background: var(--inp-bg);
            color: var(--text);
            font-size: 15px;
            outline: none;
            transition: 0.3s;
        }
        .login-input:focus {
            border-color: var(--p);
            box-shadow: 0 0 0 3px var(--glow);
        }
        .login-btn {
            width: 100%;
            padding: 16px;
            margin-top: 12px;
            border: none;
            border-radius: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 16px;
        }
        .login-btn:active {
            transform: scale(0.96);
        }
        .login-btn-primary { background: var(--p); color: white; }
        .login-btn-success { background: var(--s); color: white; }
        .login-btn:hover { opacity: 0.9; transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        .employee-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }
        .emp-select-btn {
            background: var(--card);
            border: 2px solid var(--border);
            color: var(--text);
            padding: 15px 8px;
            border-radius: 22px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .emp-select-btn:hover {
            border-color: var(--p);
            transform: scale(1.03);
            box-shadow: 0 0 20px var(--glow);
        }
        .emp-select-btn.selected {
            border-color: var(--s);
            background: rgba(16, 185, 129, 0.15);
        }

        /* شاشة اختيار الموظف */
        #selectionScreen { 
            padding: 20px; 
            animation: fadeIn 0.6s ease;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: calc(var(--footer-height) + 20px);
        }

        .brand-card {
            background: linear-gradient(135deg, var(--p), #1d4ed8);
            border-radius: 30px;
            padding: 35px 25px;
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 0 30px var(--glow), 0 15px 30px -10px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: var(--card);
            padding: 20px;
            border-radius: 22px;
            border-bottom: 4px solid var(--p);
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-card small { color: #94a3b8; font-size: 12px; display: block; margin-bottom: 8px; }
        .stat-card div { font-weight: 900; font-size: 18px; color: var(--s); }

        .search-box {
            margin-bottom: 20px;
        }
        .search-box input {
            width: 100%;
            padding: 18px 20px;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: 0.3s;
        }
        .search-box input:focus {
            border-color: var(--p);
            box-shadow: 0 0 0 3px var(--glow);
        }

        .emp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .emp-grid-item {
            background: var(--card);
            padding: 20px 12px;
            border-radius: 22px;
            border: 1px solid var(--border);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 15px;
        }
        .emp-grid-item:hover {
            border-color: var(--p);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .emp-grid-item:active {
            transform: scale(0.96);
        }

        /* لوحة الموظف الرئيسية */
        #mainDashboard {
            display: none;
            padding: 20px;
            padding-bottom: calc(var(--footer-height) + 20px);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            animation: fadeIn 0.5s ease;
        }

        .quick-info-bar {
            background: var(--card);
            border-radius: 22px;
            padding: 18px 15px;
            margin: 0 0 20px 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border: 1px solid var(--border);
        }
        @media (max-width: 480px) {
            .quick-info-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
        .quick-info-item {
            text-align: center;
        }
        .quick-info-item small {
            color: #94a3b8;
            font-size: 11px;
            display: block;
            margin-bottom: 5px;
        }
        .quick-info-item span {
            font-weight: 800;
            color: var(--s);
            font-size: 16px;
        }

        .tab-content {
            margin-bottom: 20px;
        }
        .tab-pane {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        .tab-pane.active {
            display: block;
        }

        .action-card {
            background: var(--card);
            border-radius: 28px;
            padding: 25px 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            text-align: center;
            background-image: linear-gradient(145deg, var(--card), var(--bg));
        }
        .clock-display {
            font-size: clamp(40px, 12vw, 60px);
            font-weight: 900;
            color: var(--s);
            text-align: center;
            margin: 15px 0 25px 0;
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
            letter-spacing: 2px;
            direction: ltr;
        }

        .btn-modern {
            border: none;
            padding: 18px;
            border-radius: 22px;
            font-weight: 800;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            width: 100%;
        }
        .btn-modern:active { transform: scale(0.96); }
        .btn-start-grad { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-break-grad { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-stop-grad { background: linear-gradient(135deg, #ef4444, #dc2626); }

        .controls-flex {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        @media (max-width: 480px) {
            .controls-flex {
                flex-direction: column;
            }
        }

        .card {
            background: var(--card);
            border-radius: 24px;
            padding: 22px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .inp {
            width: 100%;
            padding: 16px;
            background: var(--inp-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 18px;
            outline: none;
            font-size: 15px;
            transition: 0.3s;
        }
        .inp:focus {
            border-color: var(--p);
            box-shadow: 0 0 0 3px var(--glow);
        }

        /* شريط المهام السفلي للموظف */
        .bottom-taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            backdrop-filter: blur(20px);
            border-top: 2px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 6px 8px;
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
            height: 75px;
            gap: 6px;
        }
        .taskbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 11px;
            cursor: pointer;
            padding: 8px 0;
            border-radius: 16px;
            transition: all 0.3s;
            flex: 1;
            opacity: 0.7;
            height: 100%;
            max-width: 80px;
        }
        .taskbar-item.active {
            background: var(--p);
            opacity: 1;
            color: white;
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4);
        }
        .taskbar-item .icon { 
            font-size: 22px;
        }

        /* لوحة المدير */
        #mgrModal {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: none;
            z-index: 2000;
            overflow-y: auto;
        }

        .mgr-top-bar {
            position: sticky;
            top: 0;
            z-index: 2100;
            background: var(--card);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid var(--p);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            height: 70px;
        }
        .mgr-top-bar .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: bold;
            background: var(--inp-bg);
            padding: 8px 18px;
            border-radius: 40px;
            border: 1px solid var(--border);
        }
        .mgr-back-btn {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--d);
            color: var(--d);
            padding: 10px 22px;
            border-radius: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            transition: 0.3s;
            font-size: 16px;
        }
        .mgr-back-btn:hover {
            background: var(--d);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--d);
        }

        .mgr-container {
            width: 100%;
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px 20px calc(var(--footer-height) + 20px);
        }

        .mgr-bottom-taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            backdrop-filter: blur(20px);
            border-top: 2px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 6px 8px;
            z-index: 2100;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
            height: 75px;
            gap: 6px;
        }
        .mgr-taskbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 11px;
            cursor: pointer;
            padding: 8px 0;
            border-radius: 16px;
            transition: all 0.3s;
            flex: 1;
            opacity: 0.7;
            height: 100%;
            max-width: 70px;
        }
        .mgr-taskbar-item.active {
            background: var(--p);
            opacity: 1;
            color: white;
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4);
        }
        .mgr-taskbar-item .icon { 
            font-size: 22px;
        }

        .mgr-tab-content {
            min-height: 70vh;
            background: var(--card);
            border-radius: 30px;
            padding: 30px;
            border: 1px solid var(--border);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.5s ease;
        }

        .mgr-tab-pane { display: none; }
        .mgr-tab-pane.active { display: block; }

        /* ===== تحسينات بطاقات المالية - بحجم مناسب ===== */
        .finance-cards-container {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 25px;
            margin: 20px auto 30px;
            max-width: 900px;
            padding: 0 15px;
        }

        @media (max-width: 768px) {
            .finance-cards-container {
                flex-direction: column;
                gap: 20px;
            }
        }

        .finance-card {
            flex: 1;
            background: linear-gradient(145deg, var(--card), var(--inp-bg));
            padding: 25px 20px 20px;
            border-radius: 30px;
            border: 1px solid var(--border);
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 220px;
            box-shadow: 0 15px 25px -8px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .finance-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--p), var(--s));
            border-radius: 30px 30px 0 0;
        }

        .finance-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 35px -12px var(--glow);
            border-color: var(--p);
        }

        .finance-card:hover .finance-icon {
            transform: scale(1.1);
            background: var(--p);
            color: white;
            border-color: var(--p);
        }

        .finance-icon {
            font-size: 40px;
            margin-bottom: 15px;
            background: rgba(59, 130, 246, 0.1);
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin: 0 auto 15px auto;
            border: 3px solid;
            transition: all 0.3s;
        }

        .salary-card .finance-icon {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .debt-card .finance-icon {
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .finance-label {
            font-size: 18px;
            color: #94a3b8;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .finance-amount {
            font-size: 32px;
            font-weight: 900;
            line-height: 1.2;
            text-align: center;
            width: 100%;
            padding: 8px 15px;
            border-radius: 50px;
            margin-bottom: 5px;
            background: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.1);
        }

        .salary-amount {
            color: #10b981;
        }

        .debt-amount {
            color: #f59e0b;
        }

        .finance-note {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
            font-weight: 400;
        }

        /* تحسين أزرار المالية */
        .finance-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 20px 0 20px;
        }

        .finance-action-btn {
            background: linear-gradient(145deg, var(--card), var(--inp-bg));
            border: 1px solid var(--border);
            color: var(--text);
            padding: 14px 10px;
            border-radius: 24px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        .finance-action-btn:hover {
            border-color: var(--p);
            transform: translateY(-3px);
            box-shadow: 0 12px 20px -6px var(--glow);
        }

        .finance-action-btn i {
            font-size: 18px;
        }

        /* ===== قسم التقارير المحسن ===== */
        #mgrTabReports {
            padding: 0 5px;
        }

        .reports-header {
            margin-bottom: 25px;
        }

        .reports-header h2 {
            font-size: 24px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--p), var(--s));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        .reports-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        @media (max-width: 480px) {
            .reports-stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .reports-stat-card {
            background: var(--inp-bg);
            border-radius: 20px;
            padding: 20px 15px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .reports-stat-card:hover {
            transform: translateY(-3px);
            border-color: var(--p);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .reports-stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon-blue { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .stat-icon-green { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .stat-icon-orange { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .stat-icon-purple { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .stat-icon-red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .stat-icon-pink { background: rgba(236, 72, 153, 0.2); color: #ec4899; }

        .reports-stat-content h4 {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .reports-stat-value {
            font-size: 22px;
            font-weight: 800;
            color: var(--text);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: var(--card);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 350px;
        }

        .chart-card:hover {
            border-color: var(--p);
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
        }

        .chart-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .chart-icon {
            width: 40px;
            height: 40px;
            border-radius: 14px;
            background: var(--inp-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .chart-title {
            flex: 1;
        }

        .chart-title h4 {
            font-size: 16px;
            margin-bottom: 3px;
            color: var(--text);
        }

        .chart-title small {
            font-size: 12px;
            color: #94a3b8;
        }

        .chart-badge {
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            background: var(--inp-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .chart-container {
            flex: 1;
            min-height: 0;
            position: relative;
            width: 100%;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
            max-height: 250px;
        }

        .advanced-analytics {
            background: linear-gradient(145deg, var(--inp-bg), var(--card));
            border-radius: 24px;
            padding: 25px;
            border: 1px solid var(--border);
            margin-top: 20px;
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .analytics-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .analytics-filter-btn {
            background: var(--inp-bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .analytics-filter-btn.active {
            background: var(--p);
            border-color: var(--p);
            color: white;
        }
        .analytics-filter-btn:hover {
            border-color: var(--p);
        }

        .kpi-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .kpi-card {
            background: var(--inp-bg);
            border-radius: 20px;
            padding: 20px 15px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--s);
            margin: 10px 0;
        }

        .kpi-label {
            font-size: 13px;
            color: #94a3b8;
        }

        .kpi-trend {
            font-size: 12px;
            margin-top: 5px;
        }
        .trend-up { color: var(--s); }
        .trend-down { color: var(--d); }

        .performance-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .performance-card {
            background: var(--card);
            border-radius: 22px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        .performance-card:hover {
            border-color: var(--s);
        }

        .performance-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .performance-avatar {
            width: 50px;
            height: 50px;
            border-radius: 16px;
            background: var(--p);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .performance-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .performance-stat-item {
            text-align: center;
            padding: 10px;
            background: var(--inp-bg);
            border-radius: 16px;
        }

        .performance-progress {
            height: 8px;
            background: var(--inp-bg);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .performance-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--p), var(--s));
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .heatmap-section {
            margin-top: 25px;
            background: var(--card);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .heatmap-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .heatmap-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .heatmap-label {
            width: 80px;
            font-size: 13px;
            color: #94a3b8;
        }

        .heatmap-bars {
            flex: 1;
            display: flex;
            gap: 4px;
            height: 40px;
            direction: ltr;
        }

        .heatmap-bar {
            flex: 1;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        .heatmap-bar:hover {
            transform: scaleY(1.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .heatmap-bar:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 11px;
            white-space: nowrap;
            border: 1px solid var(--border);
            margin-bottom: 5px;
            z-index: 10;
        }

        /* بطاقات المدير - تصميم محسن وموسّط */
        .mgr-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) {
            .mgr-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 480px) {
            .mgr-stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .mgr-stat-card {
            background: linear-gradient(145deg, var(--card), var(--inp-bg));
            padding: 25px 15px;
            border-radius: 28px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 25px -8px rgba(0,0,0,0.3);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 180px;
        }
        .mgr-stat-card:hover {
            transform: translateY(-8px);
            border-color: var(--p);
            box-shadow: 0 20px 30px -8px var(--glow);
        }
        .mgr-stat-card .stat-icon { 
            font-size: 36px; 
            margin-bottom: 15px; 
            background: var(--inp-bg);
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin: 0 auto 15px auto;
            border: 2px solid var(--p);
            color: var(--p);
            transition: all 0.3s;
        }
        .mgr-stat-card:hover .stat-icon {
            background: var(--p);
            color: white;
            border-color: var(--p);
            transform: scale(1.1);
        }
        .mgr-stat-card .stat-value {
            font-size: 32px;
            font-weight: 900;
            color: var(--s);
            line-height: 1.2;
            margin-bottom: 5px;
            word-break: break-word;
        }
        .mgr-stat-card .stat-label {
            font-size: 16px;
            color: #94a3b8;
            font-weight: 600;
        }

        /* بطاقة خاصة للصف الكامل */
        .mgr-stat-card-full {
            grid-column: span 2;
        }
        @media (max-width: 900px) {
            .mgr-stat-card-full {
                grid-column: span 1;
            }
        }

        .add-emp-modern {
            background: var(--inp-bg);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }

        .emp-list-modern {
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
            position: relative;
        }
        .emp-item-modern {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--inp-bg);
            padding: 18px 20px;
            margin-bottom: 12px;
            border-radius: 22px;
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .emp-item-modern:hover {
            border-color: var(--p);
            transform: translateX(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .emp-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            cursor: pointer;
        }
        .emp-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--p);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .emp-actions-vertical {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-right: 10px;
        }
        .emp-action-btn {
            background: var(--border);
            border: none;
            color: var(--text);
            width: 42px;
            height: 42px;
            border-radius: 14px;
            cursor: pointer;
            font-size: 20px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .emp-action-btn:hover { background: var(--p); color: white; transform: scale(1.1); }
        .emp-action-btn.delete:hover { background: var(--d); }

        .leave-request-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--inp-bg);
            padding: 15px 20px;
            border-radius: 20px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 15px;
        }
        .leave-info {
            flex: 2;
            min-width: 200px;
        }
        .leave-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .leave-action-btn {
            border: none;
            color: white;
            padding: 8px 18px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .leave-action-btn.approve { background: var(--s); }
        .leave-action-btn.reject { background: var(--d); }
        .leave-action-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 15px;
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: var(--bg);
            color: var(--text);
            width: 100%;
            max-width: 450px;
            padding: 30px;
            border-radius: 30px;
            border: 1px solid var(--border);
            max-height: 90vh;
            overflow-y: auto;
        }

        .btn {
            border: none;
            padding: 16px;
            border-radius: 18px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 15px;
            color: white;
            transition: all 0.2s;
        }
        .btn:active {
            transform: scale(0.96);
        }
        .btn-p { background: var(--p); }
        .btn-s { background: var(--s); }
        .btn-d { background: var(--d); }

        /* سكرول أنيق */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 20px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--p); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseSync { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* إصلاحات الاتجاه */
        #mgrModal, .mgr-top-bar, .mgr-container, .mgr-tab-content, .mgr-tab-pane,
        .reports-header, .reports-stats-grid, .reports-stat-card, .charts-grid,
        .chart-card, .chart-header, .advanced-analytics, .performance-cards,
        .performance-card, .heatmap-section, .kpi-indicators, .kpi-card,
        #selectionScreen, .brand-card, .stats-grid, .stat-card, .search-box,
        .emp-grid, #mainDashboard, .quick-info-bar, .tab-content, .tab-pane,
        .action-card, .card, .mgr-stats-grid, .mgr-stat-card,
        .finance-cards-container, .finance-card, .finance-actions-grid {
            direction: rtl !important;
            text-align: right !important;
        }

        .clock-display {
            direction: ltr !important;
            text-align: center !important;
        }

        /* تحسينات إضافية للتبويب المالي */
        .whatsapp-btn {
            background: #25D366;
            color: white;
            padding: 14px;
            border-radius: 14px;
            width: 100%;
            border: none;
            font-weight: bold;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .whatsapp-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(37, 211, 102, 0.4);
        }
    </style>
</head>
<body>

    <!-- قالب PDF المحسن -->
    <div id="receiptTemplate" style="display: none; padding: 30px; background: white; color: #333; width: 500px; direction: rtl;">
        <div class="receipt-header" style="text-align: center; border-bottom: 2px solid #3b82f6; padding-bottom: 15px; margin-bottom: 20px;">
            <div id="receiptLogoPlace" style="width: 80px; height: 80px; margin: 0 auto 10px;"></div>
            <h2 id="receiptCompanyName">اسم الشركة</h2>
            <p>وصل استلام راتب شهر <span id="receiptDate"></span></p>
        </div>
        <div class="receipt-row" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ccc;">
            <span>اسم الموظف:</span><b id="rEmpName"></b>
        </div>
        <div class="receipt-row" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ccc;">
            <span>إجمالي ساعات العمل:</span><b id="rEmpTime"></b>
        </div>
        <div class="receipt-row" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ccc;">
            <span>أجر الساعات الكلي:</span><b id="rEmpBase"></b>
        </div>
        <div class="receipt-row" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ccc;">
            <span>إضافات (مكافآت):</span><b id="rEmpBonus" style="color: green;"></b>
        </div>
        <div class="receipt-row" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ccc;">
            <span>خصومات وسلف:</span><b id="rEmpDeduct" style="color: red;"></b>
        </div>
        <div class="receipt-row" style="display: flex; justify-content: space-between; background: #f0f4ff; padding: 15px 5px; border-bottom: none; margin-top: 10px;">
            <span>صافي المبلغ المستلم:</span><b id="rEmpFinal" style="font-size: 20px; color: #3b82f6;"></b>
        </div>
        <div class="receipt-footer" style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
            <p>توقيع المحاسب: .............................</p>
            <p>تم استلام المبلغ المذكور أعلاه نقداً</p>
            <small>صدر بواسطة نظام الإدارة الذكي 2026</small>
        </div>
    </div>

    <!-- شاشات البداية -->
    <div id="loginScreen">
        <div class="login-box">
            <h2>🔐 تسجيل الدخول</h2>
            <div id="employeeSelector" class="employee-selector-grid"></div>
            <div id="loginFieldsContainer" style="display: none; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px;">
                <div class="form-floating">
                    <input type="email" id="authEmail" placeholder=" ">
                    <label>البريد الإلكتروني</label>
                </div>
                <div class="form-floating">
                    <input type="password" id="authPass" placeholder=" ">
                    <label>كلمة المرور</label>
                </div>
                <button onclick="loginUser()" class="login-btn login-btn-primary">دخول</button>
            </div>
            <div style="margin-top: 20px;">
                <button onclick="showRegisterForm()" class="login-btn" style="background: #475569; color: #fff;">📝 إنشاء حساب جديد</button>
            </div>
        </div>
    </div>

    <div id="registerScreen" style="display: none;">
        <div class="login-box">
            <h2>إنشاء حساب جديد</h2>
            <div class="form-floating">
                <input type="text" id="regName" placeholder=" ">
                <label>الاسم الكامل</label>
            </div>
            <div class="form-floating">
                <input type="email" id="regEmail" placeholder=" ">
                <label>البريد الإلكتروني</label>
            </div>
            <div class="form-floating">
                <input type="password" id="regPass" placeholder=" ">
                <label>كلمة المرور</label>
            </div>
            <div class="form-floating">
                <input type="password" id="regConfirmPass" placeholder=" ">
                <label>تأكيد كلمة المرور</label>
            </div>
            <select id="regRole" class="login-input" style="background: var(--inp-bg); color: var(--text);">
                <option value="employee">موظف</option>
                <option value="admin">مدير</option>
            </select>
            <button onclick="registerUser()" class="login-btn login-btn-primary" style="margin-top: 15px;">تسجيل</button>
            <button onclick="backToLogin()" class="login-btn" style="background: #475569; color: #fff; margin-top: 10px;">رجوع</button>
        </div>
    </div>

    <div id="firstAdminScreen" style="display: none;">
        <div class="login-box" style="border: 2px solid #a855f7;">
            <div style="font-size: 60px; margin-bottom: 10px;">👑</div>
            <h2 style="color: var(--text);">مرحباً بك في النظام</h2>
            <div style="background: rgba(168, 85, 247, 0.2); padding: 15px; border-radius: 15px; margin-bottom: 20px;">
                <p style="color: var(--text); margin: 0; font-size: 14px;">
                    ⭐ <strong>أنت أول مستخدم، سيتم تسجيلك كمدير عام</strong>
                </p>
            </div>
            <div class="form-floating">
                <input type="text" id="firstAdminName" placeholder=" " value="المدير العام">
                <label>الاسم الكامل</label>
            </div>
            <div class="form-floating">
                <input type="email" id="firstAdminEmail" placeholder=" " value="admin@company.com">
                <label>البريد الإلكتروني</label>
            </div>
            <div class="form-floating">
                <input type="password" id="firstAdminPass" placeholder=" " value="12345678">
                <label>كلمة المرور</label>
            </div>
            <button onclick="createFirstAdmin()" class="login-btn" style="background: #a855f7; color: white; font-weight: bold; padding: 16px; margin-top: 15px;">
                👑 إنشاء حساب المدير الأول
            </button>
        </div>
    </div>

    <!-- إشعارات Toast -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- شريط التعميمات -->
    <div id="announcementBar" class="announcement-bar">📢 لا توجد تعميمات جديدة</div>

    <!-- الشريط العلوي الرئيسي -->
    <div class="top-taskbar">
        <div class="cloud-status" id="cloudStatus">
            <div class="cloud-dot" id="cloudDot"></div>
            <span id="cloudText">غير متصل</span>
        </div>
        <div class="icon-btn-group">
            <button class="icon-btn" onclick="rotateTheme()" id="themeIcon">🌙</button>
            <button onclick="logoutUser()" class="logout-btn" title="تسجيل الخروج">🚪</button>
            <button class="icon-btn" onclick="openAdminPanel()" style="border-right: 3px solid var(--p);">⚙️</button>
        </div>
    </div>

    <!-- شاشة اختيار الموظف (للمدير) -->
    <div id="selectionScreen">
        <div class="brand-card">
            <div class="brand-card-logo" id="displayLogo" style="width: 100px; height: 100px; background: white; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 50px; margin-bottom: 15px;">💼</div>
            <div class="brand-card-info">
                <h1 id="displayName" style="font-size: 24px; margin: 10px 0;">نظام الإدارة المتكامل</h1>
                <p>إدارة الموارد البشرية والرواتب الذكية 2026</p>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><small>💰 إجمالي المستحقات</small><div id="statTotalCash">0 د.ع</div></div>
            <div class="stat-card" style="border-color: var(--w);"><small>👥 المداومون الآن</small><div id="statActiveCount" style="color: var(--w);">0</div></div>
            <div class="stat-card" style="grid-column: span 2; border-color: var(--s);"><small>🏆 الأعلى إنتاجية</small><div id="statTopEmp" style="color: var(--s);">---</div></div>
        </div>

        <div class="search-box">
            <input type="text" id="searchBar" placeholder="🔍 ابحث عن اسم الموظف..." oninput="drawSelection()">
        </div>
        <div id="empGrid" class="emp-grid"></div>
    </div>

    <!-- لوحة تحكم الموظف -->
    <div id="mainDashboard">
        <!-- المعلومات السريعة -->
        <div class="quick-info-bar">
            <div class="quick-info-item"><small>الموظف</small><br><span id="fNameHome">---</span></div>
            <div class="quick-info-item"><small>الصافي</small><br><span id="fMoneyHome">0 د.ع</span></div>
            <div class="quick-info-item"><small>الزمن</small><br><span id="fTimeHome">0س 0د</span></div>
        </div>

        <!-- التبويبات -->
        <div class="tab-content">
            <!-- الصفحة الرئيسية -->
            <div class="tab-pane active" id="tabHome">
                <div class="card">
                    <h4 style="margin-bottom: 15px;">مرحباً بك في لوحتك الشخصية</h4>
                    <p style="color: #94a3b8; line-height: 1.6;">يمكنك متابعة ساعات العمل والعمليات المالية من خلال التبويبات أدناه.</p>
                </div>
            </div>

            <!-- تبويب الحضور -->
            <div class="tab-pane" id="tabAttendance">
                <div class="action-card">
                    <small style="color: #94a3b8; font-weight: bold;">سجل الدوام والحضور</small>
                    <div class="clock-display" id="clock">00:00:00</div>
                    <button id="startBtn" class="btn-modern btn-start-grad" onclick="startShift()"><span>▶️</span> بدء الدوام الآن</button>
                    <div id="activeControls" style="display:none;" class="controls-flex">
                        <button id="breakBtn" class="btn-modern btn-break-grad" onclick="toggleBreak()" style="flex: 1.2;">☕ استراحة</button>
                        <button class="btn-modern btn-stop-grad" onclick="stopShift()" style="flex: 1;">🛑 إنهاء</button>
                    </div>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <h4>⏱️ السجل الحالي</h4>
                    <div id="logsBox" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- تبويب المالية -->
            <div class="tab-pane" id="tabFinance">
                <div class="card">
                    <h4 style="margin-bottom: 20px;">💰 العمليات المالية</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                        <input type="number" id="moneyAmount" class="inp" placeholder="المبلغ">
                        <select id="moneyType" class="inp" onchange="toggleInstallmentField()">
                            <option value="bonus">🟢 مكافأة</option>
                            <option value="deduct">🔴 استقطاع</option>
                            <option value="debt">💸 سلفة</option>
                            <option value="installment">📅 سلفة مقسطة</option>
                        </select>
                    </div>
                    <input type="number" id="installAmount" class="inp" placeholder="القسط..." style="display:none; margin-top:12px;">
                    <input type="text" id="moneyReason" class="inp" placeholder="السبب..." style="margin-top: 12px;">
                    <button class="btn btn-p" style="margin-top: 15px;" onclick="addFinancial()">إضافة العملية</button>
                    <div id="activeDebtsBox" style="margin-top:15px; max-height:100px; overflow-y:auto;"></div>
                    <div id="financialLogs" style="margin-top:15px; max-height:200px; overflow-y:auto;"></div>
                </div>
            </div>

            <!-- تبويب الإجازات -->
            <div class="tab-pane" id="tabLeaves">
                <div class="card">
                    <h4 style="margin-bottom: 20px;">📅 طلب إجازة</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                        <input type="date" id="leaveDate" class="inp">
                        <select id="leaveType" class="inp">
                            <option value="اعتيادية">اعتيادية</option>
                            <option value="مرضية">مرضية</option>
                        </select>
                    </div>
                    <button class="btn btn-p" style="margin-top:15px" onclick="requestLeave()">إرسال الطلب</button>
                    <div id="myLeavesStatus" style="margin-top:15px; max-height:200px; overflow-y:auto;"></div>
                </div>
            </div>

            <!-- تبويب الملف الشخصي -->
            <div class="tab-pane" id="tabProfile">
                <div class="card">
                    <h4 style="margin-bottom: 20px;">🔒 تغيير كلمة المرور</h4>
                    <div class="form-floating">
                        <input type="password" id="currentPassInp" placeholder=" ">
                        <label>كلمة المرور الحالية</label>
                    </div>
                    <div class="form-floating">
                        <input type="password" id="newPassInp" placeholder=" ">
                        <label>كلمة المرور الجديدة</label>
                    </div>
                    <button class="btn btn-s" style="margin-top:15px" onclick="changeMyPassword()">تحديث كلمة المرور</button>
                </div>
                <div class="card" style="margin-top: 15px;">
                    <h4 style="margin-bottom: 15px;">📂 أرشيف الحسابات</h4>
                    <div class="form-floating">
                        <input type="text" id="archiveSearch" placeholder=" " oninput="drawArchive()">
                        <label>🔍 ابحث بالتاريخ</label>
                    </div>
                    <div id="archiveBox" style="margin-top:15px; max-height:180px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <!-- شريط المهام السفلي للموظف -->
        <div class="bottom-taskbar">
            <button class="taskbar-item active" onclick="switchTab('home')" id="tabHomeBtn"><span class="icon">🏠</span><span>الرئيسية</span></button>
            <button class="taskbar-item" onclick="switchTab('attendance')" id="tabAttendanceBtn"><span class="icon">⏰</span><span>الحضور</span></button>
            <button class="taskbar-item" onclick="switchTab('finance')" id="tabFinanceBtn"><span class="icon">💰</span><span>المالية</span></button>
            <button class="taskbar-item" onclick="switchTab('leaves')" id="tabLeavesBtn"><span class="icon">📅</span><span>الإجازات</span></button>
            <button class="taskbar-item" onclick="switchTab('profile')" id="tabProfileBtn"><span class="icon">👤</span><span>الملف</span></button>
        </div>
    </div>

    <!-- نافذة تعديل بيانات الموظف -->
    <div id="editEmpModal" class="modal">
        <div class="modal-content">
            <h3 style="text-align: center; margin-bottom: 20px;">✏️ تعديل بيانات الموظف</h3>
            <div class="form-floating">
                <input type="text" id="editEmpNameInp" placeholder=" ">
                <label>الاسم الجديد</label>
            </div>
            <div class="form-floating">
                <input type="email" id="editEmpEmailInp" placeholder=" ">
                <label>البريد الإلكتروني الجديد</label>
            </div>
            <div class="form-floating">
                <input type="password" id="editEmpPassInp" placeholder=" ">
                <label>كلمة المرور الجديدة (اختياري)</label>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button class="btn btn-s" style="flex:2;" onclick="saveNewEmpData()">💾 حفظ</button>
                <button class="btn" style="flex:1; background: var(--border);" onclick="closeEditModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة مدير -->
    <div id="addAdminModal" class="modal">
        <div class="modal-content" style="border-color: #a855f7;">
            <h3 style="text-align: center; margin-bottom: 20px; color: #a855f7;">👑 إضافة مدير جديد</h3>
            <div class="form-floating">
                <input type="text" id="newAdminName" placeholder=" ">
                <label>اسم المدير</label>
            </div>
            <div class="form-floating">
                <input type="email" id="newAdminEmail" placeholder=" ">
                <label>البريد الإلكتروني</label>
            </div>
            <div class="form-floating">
                <input type="password" id="newAdminPass" placeholder=" ">
                <label>كلمة المرور</label>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button class="btn" style="background: #a855f7; flex:2;" onclick="createAdditionalAdmin()">➕ إضافة</button>
                <button class="btn" style="flex:1; background: var(--border);" onclick="closeAddAdminModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- لوحة تحكم المدير -->
    <div id="mgrModal">
        <!-- الشريط العلوي الثابت للمدير -->
        <div class="mgr-top-bar">
            <div class="user-info">
                👑 <span id="mgrUserName">المدير</span>
            </div>
            <button class="mgr-back-btn" onclick="closeMgr()">
                <span>🔙</span> العودة
            </button>
        </div>

        <div class="mgr-container">
            <!-- محتوى التبويبات -->
            <div class="mgr-tab-content">
                <!-- الصفحة الرئيسية للمدير - بطاقات محسنة -->
                <div class="mgr-tab-pane active" id="mgrTabHome">
                    <div class="mgr-stats-grid">
                        <!-- بطاقة إجمالي الرواتب - موسعة -->
                        <div class="mgr-stat-card mgr-stat-card-full">
                            <div class="stat-icon">💰</div>
                            <div class="stat-value" id="statTotalSalaries">0 د.ع</div>
                            <div class="stat-label">إجمالي الرواتب</div>
                        </div>
                        <!-- بطاقة إجمالي السلف - موسعة -->
                        <div class="mgr-stat-card mgr-stat-card-full">
                            <div class="stat-icon">💳</div>
                            <div class="stat-value" id="financeTotalDebts">0 د.ع</div>
                            <div class="stat-label">إجمالي السلف</div>
                        </div>
                        <!-- بطاقة إجمالي الموظفين -->
                        <div class="mgr-stat-card">
                            <div class="stat-icon">👥</div>
                            <div class="stat-value" id="statTotalEmployees">0</div>
                            <div class="stat-label">إجمالي الموظفين</div>
                        </div>
                        <!-- بطاقة المداومون الآن -->
                        <div class="mgr-stat-card">
                            <div class="stat-icon">⏰</div>
                            <div class="stat-value" id="statActiveNow">0</div>
                            <div class="stat-label">مداومون الآن</div>
                        </div>
                        <!-- بطاقة طلبات الإجازة -->
                        <div class="mgr-stat-card">
                            <div class="stat-icon">📅</div>
                            <div class="stat-value" id="statPendingLeaves">0</div>
                            <div class="stat-label">طلبات إجازة</div>
                        </div>
                    </div>

                    <div id="adminAlertsBox" style="background: rgba(239, 68, 68, 0.1); border-radius: 20px; padding: 20px; margin-bottom: 25px;">
                        <h4 style="color:var(--d); margin-bottom:15px;">🚨 مراقبة التأخير</h4>
                        <div id="adminAlertsList"></div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom:15px;">📢 إرسال تعميم</h4>
                        <div class="form-floating">
                            <input type="text" id="announceInp" placeholder=" ">
                            <label>نص التعميم</label>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 15px;">
                            <button class="btn btn-s" style="flex:2;" onclick="publishAnnouncement()">نشر</button>
                            <button class="btn btn-d" style="flex:1;" onclick="clearAnnouncement()">حذف</button>
                        </div>
                    </div>
                </div>

                <!-- الموظفين -->
                <div class="mgr-tab-pane" id="mgrTabEmployees">
                    <div style="display: flex; gap: 12px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="btn" style="background: #a855f7; flex: 1; min-width: 140px;" onclick="openAddAdminModal()">
                            <span style="font-size: 1.2rem;">👑</span> إضافة مدير
                        </button>
                        <button class="btn btn-s" style="flex: 1; min-width: 140px;" onclick="toggleQuickAddSection()">
                            <span style="font-size: 1.2rem;">➕</span> إضافة موظف
                        </button>
                    </div>

                    <div id="quickAddSection" class="card" style="padding: 20px; margin-bottom: 25px; display: none;">
                        <h4 style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                            <span>✨</span> إضافة موظف جديد
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="form-floating">
                                <input type="text" id="addEmpName" placeholder=" ">
                                <label>الاسم الكامل</label>
                            </div>
                            <div class="form-floating">
                                <input type="email" id="addEmpEmail" placeholder=" ">
                                <label>البريد الإلكتروني</label>
                            </div>
                            <div class="form-floating">
                                <input type="password" id="addEmpPass" placeholder=" ">
                                <label>كلمة المرور</label>
                            </div>
                        </div>
                        <button class="btn btn-p" style="width: 100%; margin-top: 20px;" onclick="addNewEmp()">
                            💾 حفظ الموظف الجديد
                        </button>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4>👥 قائمة الموظفين</h4>
                        <span class="stat-value" style="font-size: 1.2rem; color: var(--text); background: var(--inp-bg); padding: 5px 15px; border-radius: 20px;" id="statTotalEmployeesMini">0</span>
                    </div>
                    <div id="mgrEmpList" class="emp-list-modern"></div>
                </div>

                <!-- المالية - بطاقات محسنة بحجم مناسب -->
                <div class="mgr-tab-pane" id="mgrTabFinance">
                    <!-- بطاقات المالية المحسنة بحجم مناسب -->
                    <div class="finance-cards-container">
                        <!-- بطاقة إجمالي الرواتب -->
                        <div class="finance-card salary-card">
                            <div class="finance-icon">💰</div>
                            <div class="finance-label">إجمالي الرواتب</div>
                            <div class="finance-amount salary-amount" id="financeTotalSalaries">0 د.ع</div>
                            <div class="finance-note">شامل المكافآت والاستقطاعات</div>
                        </div>
                        
                        <!-- بطاقة إجمالي السلف -->
                        <div class="finance-card debt-card">
                            <div class="finance-icon">💳</div>
                            <div class="finance-label">إجمالي السلف</div>
                            <div class="finance-amount debt-amount" id="financeTotalDebts">0 د.ع</div>
                            <div class="finance-note">السلف المتبقية على الموظفين</div>
                        </div>
                    </div>

                    <!-- أزرار الإجراءات المالية -->
                    <div class="finance-actions-grid">
                        <button class="finance-action-btn" onclick="document.getElementById('xlInp').click()">
                            <span>📂</span> استيراد بصمة
                        </button>
                        <input type="file" id="xlInp" hidden accept=".xlsx,.xls" onchange="readExcel(this)">
                        
                        <button class="finance-action-btn" onclick="exportToExcel()">
                            <span>📊</span> تصدير كشف
                        </button>
                        
                        <button class="finance-action-btn" onclick="settleAccount()">
                            <span>💵</span> تصفية
                        </button>
                        
                        <button class="finance-action-btn" onclick="generateEnhancedPDF()">
                            <span>📄</span> PDF محسن
                        </button>
                        
                        <button class="finance-action-btn" onclick="sendWhatsApp()" id="waBtn" style="display:none;">
                            <span>🟢</span> إرسال WhatsApp
                        </button>
                        
                        <button class="finance-action-btn" onclick="backupData()">
                            <span>📤</span> نسخة احتياطية
                        </button>
                        
                        <button class="finance-action-btn" onclick="document.getElementById('restoreInp').click()">
                            <span>📥</span> استرجاع
                        </button>
                    </div>
                    
                    <input type="file" id="restoreInp" hidden onchange="restoreData(this)">
                </div>

                <!-- الإجازات -->
                <div class="mgr-tab-pane" id="mgrTabLeaves">
                    <h4 style="margin-bottom:20px;">🔔 طلبات الإجازات المعلقة</h4>
                    <div id="mgrLeaveRequests" style="max-height: 400px; overflow-y: auto;"></div>
                </div>

                <!-- التقارير المحسنة -->
                <div class="mgr-tab-pane" id="mgrTabReports">
                    <div class="reports-header">
                        <h2>📊 تقارير وتحليلات متقدمة</h2>
                        
                        <div class="reports-stats-grid">
                            <div class="reports-stat-card">
                                <div class="reports-stat-icon stat-icon-blue">👥</div>
                                <div class="reports-stat-content">
                                    <h4>إجمالي الموظفين</h4>
                                    <div class="reports-stat-value" id="reportStatTotal">0</div>
                                </div>
                            </div>
                            
                            <div class="reports-stat-card">
                                <div class="reports-stat-icon stat-icon-green">⏱️</div>
                                <div class="reports-stat-content">
                                    <h4>ساعات العمل</h4>
                                    <div class="reports-stat-value" id="reportStatHours">0 <small>ساعة</small></div>
                                </div>
                            </div>
                            
                            <div class="reports-stat-card">
                                <div class="reports-stat-icon stat-icon-orange">💰</div>
                                <div class="reports-stat-content">
                                    <h4>إجمالي الرواتب</h4>
                                    <div class="reports-stat-value" id="reportStatSalaries">0</div>
                                </div>
                            </div>
                            
                            <div class="reports-stat-card">
                                <div class="reports-stat-icon stat-icon-purple">💳</div>
                                <div class="reports-stat-content">
                                    <h4>السلف المستحقة</h4>
                                    <div class="reports-stat-value" id="reportStatDebts">0</div>
                                </div>
                            </div>
                            
                            <div class="reports-stat-card">
                                <div class="reports-stat-icon stat-icon-pink">📅</div>
                                <div class="reports-stat-content">
                                    <h4>الإجازات هذا الشهر</h4>
                                    <div class="reports-stat-value" id="reportStatLeaves">0</div>
                                </div>
                            </div>
                            
                            <div class="reports-stat-card">
                                <div class="reports-stat-icon stat-icon-red">⚠️</div>
                                <div class="reports-stat-content">
                                    <h4>حالات التأخير</h4>
                                    <div class="reports-stat-value" id="reportStatLate">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-icon">📊</div>
                                <div class="chart-title">
                                    <h4>أيام الحضور الشهرية</h4>
                                    <small>توزيع أيام الحضور لكل موظف</small>
                                </div>
                                <span class="chart-badge">شهري</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="attendanceChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-icon">📉</div>
                                <div class="chart-title">
                                    <h4>تحليل الاستقطاعات</h4>
                                    <small>الاستقطاعات والخصومات</small>
                                </div>
                                <span class="chart-badge">تراكمي</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="financeChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-icon">📈</div>
                                <div class="chart-title">
                                    <h4>الرواتب الشهرية</h4>
                                    <small>تطور الرواتب خلال الأشهر</small>
                                </div>
                                <span class="chart-badge">سنوي</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-icon">🥧</div>
                                <div class="chart-title">
                                    <h4>توزيع السلف</h4>
                                    <small>السلف المتبقية لكل موظف</small>
                                </div>
                                <span class="chart-badge">نسبي</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="debtChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="advanced-analytics">
                        <div class="analytics-header">
                            <h3>🔍 تحليلات الأداء المتقدمة</h3>
                            <div class="analytics-filters">
                                <button class="analytics-filter-btn active" onclick="filterAnalytics('week', event)">أسبوعي</button>
                                <button class="analytics-filter-btn" onclick="filterAnalytics('month', event)">شهري</button>
                                <button class="analytics-filter-btn" onclick="filterAnalytics('year', event)">سنوي</button>
                            </div>
                        </div>

                        <div class="kpi-indicators">
                            <div class="kpi-card">
                                <div class="kpi-value" id="kpiAttendance">98%</div>
                                <div class="kpi-label">نسبة الحضور</div>
                                <div class="kpi-trend trend-up">▲ +2.5%</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value" id="kpiProductivity">87%</div>
                                <div class="kpi-label">الإنتاجية</div>
                                <div class="kpi-trend trend-up">▲ +5%</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value" id="kpiOvertime">42</div>
                                <div class="kpi-label">ساعات إضافية</div>
                                <div class="kpi-trend trend-down">▼ -3</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value" id="kpiSatisfaction">4.5</div>
                                <div class="kpi-label">رضا الموظفين</div>
                                <div class="kpi-trend trend-up">▲ +0.3</div>
                            </div>
                        </div>

                        <div class="performance-cards" id="performanceCards"></div>
                    </div>

                    <div class="heatmap-section">
                        <h4>🔥 خريطة التزام الموظفين - آخر 30 يوم</h4>
                        <div class="heatmap-grid" id="heatmapGrid"></div>
                    </div>
                </div>

                <!-- الإعدادات -->
                <div class="mgr-tab-pane" id="mgrTabSettings">
                    <div style="text-align:center; margin-bottom:25px;">
                        <div onclick="document.getElementById('logoInp').click()" id="mgrLogo" style="width:100px; height:100px; margin:0 auto; border-radius:50%; border:2px dashed var(--p); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:50px;">💼</div>
                        <input type="file" id="logoInp" hidden accept="image/*" onchange="previewLogo(this)">
                        <small style="color:#94a3b8;">انقر لتغيير الشعار</small>
                    </div>

                    <div class="input-group">
                        <label>اسم المنشأة</label>
                        <input type="text" id="nameInp" class="inp" onchange="confirmAndSave()">
                    </div>

                    <div class="input-group">
                        <label>السمة</label>
                        <select id="themeSelect" class="inp" onchange="applyTheme(this.value)">
                            <option value="dark">🌙 مظلم</option>
                            <option value="light">☀️ فاتح</option>
                            <option value="midnight">🌌 منتصف الليل</option>
                            <option value="royal">👑 ملكي</option>
                            <option value="forest">🌲 غابة</option>
                        </select>
                    </div>

                    <div style="margin-top:25px;">
                        <h4 style="margin-bottom:15px;">🔒 تغيير كلمة المرور</h4>
                        <div class="form-floating">
                            <input type="password" id="currentAdminPass" placeholder=" ">
                            <label>كلمة المرور الحالية</label>
                        </div>
                        <div class="form-floating">
                            <input type="password" id="newAdminPass" placeholder=" ">
                            <label>كلمة المرور الجديدة</label>
                        </div>
                        <button class="btn btn-s" style="margin-top:15px;" onclick="changeAdminPassword()">تحديث</button>
                    </div>

                    <div style="margin-top:25px;">
                        <h4 style="margin-bottom:15px;">⚙️ إعدادات الموظف</h4>
                        
                        <div class="input-group">
                            <label>اختر الموظف لتعديل إعداداته</label>
                            <select id="settingsEmpSelect" class="inp" onchange="loadSelectedEmpSettings()">
                                <option value="">-- اختر موظفاً --</option>
                            </select>
                        </div>

                        <div id="empSettingsFields" style="display: none; margin-top: 20px; padding: 20px; background: var(--inp-bg); border-radius: 24px;">
                            <div class="input-group">
                                <label>💰 سعر الساعة (د.ع)</label>
                                <input type="number" id="rateInp" class="inp" placeholder="مثال: 5000" onchange="updateSettings()">
                            </div>
                            
                            <div class="input-group">
                                <label>⏱️ خصم الإكسل (بالدقائق)</label>
                                <input type="number" id="offInp" class="inp" placeholder="مثال: 30 دقيقة" onchange="updateSettings()">
                            </div>
                            
                            <div class="input-group">
                                <label>🕒 وقت بداية الدوام</label>
                                <input type="time" id="empWorkStart" class="inp" onchange="updateSettings()">
                            </div>
                            
                            <div class="input-group">
                                <label>⚠️ غرامة التأخير (د.ع)</label>
                                <input type="number" id="empLatePenalty" class="inp" placeholder="مثال: 5000" onchange="updateSettings()">
                                <small style="color: #94a3b8;">تخصم تلقائياً عند التأخير عن وقت الدوام</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شريط المدير السفلي -->
        <div class="mgr-bottom-taskbar">
            <button class="mgr-taskbar-item active" onclick="switchMgrTab('home')" id="mgrTabHomeBtn"><span class="icon">🏠</span><span>الرئيسية</span></button>
            <button class="mgr-taskbar-item" onclick="switchMgrTab('employees')" id="mgrTabEmployeesBtn"><span class="icon">👥</span><span>الموظفين</span></button>
            <button class="mgr-taskbar-item" onclick="switchMgrTab('finance')" id="mgrTabFinanceBtn"><span class="icon">💰</span><span>المالية</span></button>
            <button class="mgr-taskbar-item" onclick="switchMgrTab('leaves')" id="mgrTabLeavesBtn"><span class="icon">📅</span><span>الإجازات</span></button>
            <button class="mgr-taskbar-item" onclick="switchMgrTab('reports')" id="mgrTabReportsBtn"><span class="icon">📊</span><span>التقارير</span></button>
            <button class="mgr-taskbar-item" onclick="switchMgrTab('settings')" id="mgrTabSettingsBtn"><span class="icon">⚙️</span><span>الإعدادات</span></button>
        </div>
    </div>

    <script>
        // ================================================
        // إعدادات Firebase
        // ================================================
        const firebaseConfig = {
            apiKey: "AIzaSyACqH6y-0Ax5k9sHf7jwSdunOS6Hbomcp8",
            authDomain: "timecount-8ab50.firebaseapp.com",
            projectId: "timecount-8ab50",
            storageBucket: "timecount-8ab50.firebasestorage.app",
            messagingSenderId: "386659361532",
            appId: "1:386659361532:web:08ec0e252478f26ac1ed79",
            measurementId: "G-SVFRE5X72Y"
        };

        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db_firestore = firebase.firestore();

        // ================================================
        // نظام Cache للبيانات
        // ================================================
        const cache = {
            data: new Map(),
            timestamps: new Map(),
            
            get(key, maxAge = 300000) { // 5 دقائق
                if (this.data.has(key)) {
                    const timestamp = this.timestamps.get(key) || 0;
                    if (Date.now() - timestamp < maxAge) {
                        return this.data.get(key);
                    }
                }
                return null;
            },
            
            set(key, value) {
                this.data.set(key, value);
                this.timestamps.set(key, Date.now());
            },
            
            clear() {
                this.data.clear();
                this.timestamps.clear();
            }
        };

        // ================================================
        // نظام الإشعارات المحسن
        // ================================================
        class NotificationSystem {
            constructor() {
                this.notifications = [];
            }
            
            show(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = 'toast';
                
                const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️', p: '🔔', s: '✅', d: '❌', w: '⚠️' };
                const icon = icons[type] || '🔔';
                
                toast.innerHTML = `<span>${icon}</span> ${message}`;
                toast.style.borderRightColor = type === 's' || type === 'success' ? 'var(--s)' : 
                                              type === 'd' || type === 'error' ? 'var(--d)' : 
                                              type === 'w' || type === 'warning' ? 'var(--w)' : 'var(--p)';
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 400);
                }, duration);
            }
        }

        const notifications = new NotificationSystem();
        const showToast = (msg, type, duration) => notifications.show(msg, type, duration);

        // ================================================
        // المتغيرات العامة
        // ================================================
        let db = { 
            emps: {}, 
            config: { 
                name: "نظام الموظفين", 
                logo: null, 
                theme: "dark", 
                workStartTime: "08:00", 
                latePenalty: 0, 
                announcement: null 
            } 
        };
        let curId = null;
        let timer = null;
        let saveTimeout = null;
        let lastSettleMsg = "";
        let editingEmpId = null;
        
        // متغيرات الرسوم البيانية
        let attendanceChart = null;
        let financeChart = null;
        let monthlyChart = null;
        let debtChart = null;
        
        let currentUserRole = null;
        let selectedLoginEmpId = null;
        let isCheckingForAdmin = false;
        let isLoading = false;

        // ================================================
        // دوال مساعدة محسنة
        // ================================================
        function showLoading(show = true) {
            isLoading = show;
            const loader = document.getElementById('globalLoader');
            if (!loader && show) {
                const div = document.createElement('div');
                div.id = 'globalLoader';
                div.className = 'shimmer-loading';
                div.style.cssText = 'position:fixed; top:0; left:0; right:0; height:4px; z-index:10000;';
                document.body.appendChild(div);
            } else if (loader && !show) {
                loader.remove();
            }
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function requireAdmin() {
            if (currentUserRole !== 'admin') {
                showToast("هذه الخاصية للمدير فقط", "d");
                return false;
            }
            return true;
        }

        function requireEmployee() {
            if (!curId) {
                showToast("الرجاء اختيار موظف أولاً", "d");
                return false;
            }
            return true;
        }

        // دوال تحسين أداء Firebase
        async function loadDataFromFirestore(force = false) {
            if (!force) {
                const cached = cache.get('mainState');
                if (cached) {
                    db = cached;
                    return true;
                }
            }
            
            try {
                showLoading(true);
                const doc = await db_firestore.collection("appData").doc("mainState").get();
                
                if (doc.exists) {
                    const loadedData = JSON.parse(doc.data().data);
                    db = {
                        emps: { ...loadedData.emps },
                        config: { ...db.config, ...loadedData.config }
                    };
                    cache.set('mainState', db);
                } else {
                    db = { emps: {}, config: { ...db.config } };
                    await saveDataToFirestore();
                }
                
                showLoading(false);
                return true;
            } catch (e) {
                console.error("خطأ في تحميل البيانات:", e);
                showToast("خطأ في الاتصال بقاعدة البيانات", "d");
                showLoading(false);
                return false;
            }
        }

        async function saveDataToFirestore() {
            if (saveTimeout) clearTimeout(saveTimeout);
            
            saveTimeout = setTimeout(async () => {
                try {
                    updateCloudStatus("syncing");
                    await db_firestore.collection("appData").doc("mainState").set({
                        data: JSON.stringify(db),
                        updatedAt: new Date()
                    });
                    cache.set('mainState', db);
                    updateCloudStatus("online");
                } catch (e) {
                    console.error("خطأ في حفظ البيانات:", e);
                    updateCloudStatus("offline");
                    showToast("خطأ في حفظ البيانات", "d");
                }
            }, 1000);
        }

        async function syncUsersFromFirestore() {
            try {
                showLoading(true);
                const usersSnapshot = await db_firestore.collection("users").get();
                let hasChanges = false;
                
                const firestoreUserIds = new Set();
                usersSnapshot.forEach(doc => firestoreUserIds.add(doc.id));

                const localEmpIds = Object.keys(db.emps);
                for (const localId of localEmpIds) {
                    if (!firestoreUserIds.has(localId)) {
                        delete db.emps[localId];
                        hasChanges = true;
                    }
                }

                usersSnapshot.forEach(doc => {
                    const userId = doc.id;
                    const userData = doc.data();
                    
                    if (db.emps[userId]) {
                        if (db.emps[userId].name !== (userData.name || "مستخدم")) {
                            db.emps[userId].name = userData.name || "مستخدم";
                            hasChanges = true;
                        }
                    } else {
                        db.emps[userId] = {
                            name: userData.name || "مستخدم",
                            logs: [],
                            finance: [],
                            archive: [],
                            leaves: [],
                            debts: [],
                            rate: userData.role === 'admin' ? 5000 : 0,
                            off: 0,
                            isWorking: false,
                            onBreak: false,
                            totalMs: 0,
                            lastStart: 0,
                            workStartTime: userData.role === 'admin' ? "09:00" : "",
                            latePenalty: "0"
                        };
                        hasChanges = true;
                    }
                });
                
                if (hasChanges) await saveDataToFirestore();
                showLoading(false);
                return true;
            } catch (error) {
                console.error("خطأ في مزامنة المستخدمين:", error);
                showLoading(false);
                return false;
            }
        }

        // ================================================
        // دوال المصادحة
        // ================================================
        function showRegisterForm() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('registerScreen').style.display = 'flex';
        }

        function backToLogin() {
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }

        function toggleQuickAddSection() {
            const section = document.getElementById('quickAddSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function drawEmployeeSelector() {
            const container = document.getElementById('employeeSelector');
            if (!db.emps || Object.keys(db.emps).length === 0) {
                container.innerHTML = '<p style="grid-column: span 2; text-align: center; color: #94a3b8;">لا يوجد موظفين بعد</p>';
                return;
            }
            
            let html = '';
            for (let id in db.emps) {
                const emp = db.emps[id];
                const isSelected = (selectedLoginEmpId === id);
                html += `<button class="emp-select-btn ${isSelected ? 'selected' : ''}" onclick="selectEmployeeForLogin('${id}')">👤 ${emp.name}</button>`;
            }
            container.innerHTML = html;
        }

        async function selectEmployeeForLogin(empId) {
            selectedLoginEmpId = empId;
            drawEmployeeSelector();
            
            try {
                const doc = await db_firestore.collection("users").doc(empId).get();
                document.getElementById('authEmail').value = doc.exists ? doc.data().email || '' : '';
                document.getElementById('loginFieldsContainer').style.display = 'block';
            } catch (error) {
                console.error("خطأ في جلب بيانات المستخدم:", error);
                document.getElementById('authEmail').value = '';
                document.getElementById('loginFieldsContainer').style.display = 'block';
            }
        }

        async function registerUser() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPass').value.trim();
            const confirmPass = document.getElementById('regConfirmPass').value.trim();
            const role = document.getElementById('regRole').value;

            if (!name || !email || !pass || !confirmPass) {
                showToast("الرجاء ملء جميع الحقول", "d");
                return;
            }
            
            if (!validateEmail(email)) {
                showToast("البريد الإلكتروني غير صالح", "d");
                return;
            }
            
            if (pass.length < 6) {
                showToast("كلمة المرور يجب أن تكون 6 أحرف على الأقل", "d");
                return;
            }
            
            if (pass !== confirmPass) {
                showToast("كلمة المرور غير متطابقة", "d");
                return;
            }

            try {
                showLoading(true);
                showToast("جاري إنشاء الحساب...", "w");
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                const user = userCredential.user;
                
                await user.updateProfile({ displayName: name });
                await db_firestore.collection("users").doc(user.uid).set({ 
                    name, 
                    email, 
                    role, 
                    createdAt: new Date() 
                });

                if (!db.emps[user.uid]) {
                    db.emps[user.uid] = {
                        name, 
                        logs: [], 
                        finance: [], 
                        archive: [], 
                        leaves: [], 
                        debts: [],
                        rate: role === 'admin' ? 5000 : 0, 
                        off: 0, 
                        isWorking: false, 
                        onBreak: false, 
                        totalMs: 0, 
                        lastStart: 0,
                        workStartTime: role === 'admin' ? "09:00" : "", 
                        latePenalty: "0"
                    };
                    await saveDataToFirestore();
                }
                
                showLoading(false);
                showToast("تم إنشاء الحساب بنجاح", "s");
                backToLogin();
            } catch (error) {
                showLoading(false);
                let errorMsg = "خطأ في إنشاء الحساب";
                if (error.code === 'auth/email-already-in-use') {
                    errorMsg = "البريد الإلكتروني مستخدم بالفعل";
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = "البريد الإلكتروني غير صالح";
                } else if (error.code === 'auth/weak-password') {
                    errorMsg = "كلمة المرور ضعيفة";
                }
                showToast(errorMsg, "d");
            }
        }

        async function loginUser() {
            const email = document.getElementById('authEmail').value.trim();
            const pass = document.getElementById('authPass').value.trim();
            
            if (!email || !pass) {
                showToast("الرجاء إدخال البريد وكلمة المرور", "d");
                return;
            }
            
            if (!validateEmail(email)) {
                showToast("البريد الإلكتروني غير صالح", "d");
                return;
            }
            
            try {
                showLoading(true);
                showToast("جاري تسجيل الدخول...", "w");
                await auth.signInWithEmailAndPassword(email, pass);
                showLoading(false);
            } catch (error) {
                showLoading(false);
                let errorMsg = "خطأ في تسجيل الدخول";
                if (error.code === 'auth/user-not-found') {
                    errorMsg = "المستخدم غير موجود";
                } else if (error.code === 'auth/wrong-password') {
                    errorMsg = "كلمة المرور غير صحيحة";
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = "البريد الإلكتروني غير صالح";
                }
                showToast(errorMsg, "d");
            }
        }

        async function logoutUser() {
            try {
                if (timer) clearInterval(timer);
                timer = null;
                
                await auth.signOut();
                
                curId = null;
                selectedLoginEmpId = null;
                currentUserRole = null;
                
                document.getElementById('selectionScreen').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'none';
                document.getElementById('registerScreen').style.display = 'none';
                document.getElementById('mgrModal').style.display = 'none';
                document.getElementById('editEmpModal').style.display = 'none';
                document.getElementById('addAdminModal').style.display = 'none';
                
                document.getElementById('authEmail').value = '';
                document.getElementById('authPass').value = '';
                document.getElementById('loginFieldsContainer').style.display = 'none';
                
                await loadDataFromFirestore(true);
                await syncUsersFromFirestore();
                
                const hasAdmin = await checkIfAnyAdminExists();
                if (!hasAdmin) {
                    document.getElementById('firstAdminScreen').style.display = 'flex';
                    document.getElementById('loginScreen').style.display = 'none';
                } else {
                    document.getElementById('firstAdminScreen').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'flex';
                    drawEmployeeSelector();
                }
                
                showToast("تم تسجيل الخروج بنجاح", "s");
            } catch (error) {
                console.error("خطأ في تسجيل الخروج:", error);
                showToast("خطأ في تسجيل الخروج", "d");
            }
        }

        async function checkIfAnyAdminExists() {
            if (isCheckingForAdmin) return false;
            
            isCheckingForAdmin = true;
            try {
                if (Object.keys(db.emps).length > 0) { 
                    isCheckingForAdmin = false; 
                    return true; 
                }
                
                const usersSnapshot = await db_firestore.collection("users").where("role", "==", "admin").get();
                const hasAdmin = !usersSnapshot.empty;
                
                if (hasAdmin) {
                    usersSnapshot.forEach(doc => {
                        const userId = doc.id;
                        const userData = doc.data();
                        if (!db.emps[userId]) {
                            db.emps[userId] = {
                                name: userData.name || "مدير", 
                                logs: [], 
                                finance: [], 
                                archive: [], 
                                leaves: [], 
                                debts: [],
                                rate: 5000, 
                                off: 0, 
                                isWorking: false, 
                                onBreak: false, 
                                totalMs: 0, 
                                lastStart: 0,
                                workStartTime: "09:00", 
                                latePenalty: "0"
                            };
                        }
                    });
                    await saveDataToFirestore();
                }
                
                isCheckingForAdmin = false;
                return hasAdmin;
            } catch (error) {
                console.error("خطأ في التحقق من وجود مدير:", error);
                isCheckingForAdmin = false;
                return false;
            }
        }

        async function checkForExistingAdmin() {
            try {
                await loadDataFromFirestore(true);
                await syncUsersFromFirestore();
                
                const hasAdmin = await checkIfAnyAdminExists();
                
                if (!hasAdmin) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('firstAdminScreen').style.display = 'flex';
                } else {
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('firstAdminScreen').style.display = 'none';
                    drawEmployeeSelector();
                }
            } catch (error) {
                console.error("خطأ في التحقق من المدير:", error);
                document.getElementById('firstAdminScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }

        async function createFirstAdmin() {
            const name = document.getElementById('firstAdminName').value.trim();
            const email = document.getElementById('firstAdminEmail').value.trim();
            const pass = document.getElementById('firstAdminPass').value.trim();
            
            if (!name || !email || !pass) {
                showToast("الرجاء ملء جميع الحقول", "d");
                return;
            }
            
            if (!validateEmail(email)) {
                showToast("البريد الإلكتروني غير صالح", "d");
                return;
            }
            
            if (pass.length < 6) {
                showToast("كلمة المرور يجب أن تكون 6 أحرف على الأقل", "d");
                return;
            }

            try {
                showLoading(true);
                showToast("جاري إنشاء حساب المدير...", "w");
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                const user = userCredential.user;
                
                await user.updateProfile({ displayName: name });
                await db_firestore.collection("users").doc(user.uid).set({ 
                    name, 
                    email, 
                    role: "admin", 
                    createdAt: new Date() 
                });

                db.emps[user.uid] = {
                    name, 
                    logs: [], 
                    finance: [], 
                    archive: [], 
                    leaves: [], 
                    debts: [],
                    rate: 5000, 
                    off: 0, 
                    isWorking: false, 
                    onBreak: false, 
                    totalMs: 0, 
                    lastStart: 0,
                    workStartTime: "09:00", 
                    latePenalty: "0"
                };
                await saveDataToFirestore();

                showLoading(false);
                showToast("🎉 تم إنشاء حساب المدير بنجاح!", "s");
                
                document.getElementById('firstAdminScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                drawEmployeeSelector();
            } catch (error) {
                showLoading(false);
                let errorMsg = "خطأ في إنشاء الحساب";
                if (error.code === 'auth/email-already-in-use') {
                    errorMsg = "البريد الإلكتروني مستخدم بالفعل";
                }
                showToast(errorMsg, "d");
            }
        }

        function openAddAdminModal() {
            if (!requireAdmin()) return;
            document.getElementById('addAdminModal').style.display = 'flex';
        }

        function closeAddAdminModal() {
            document.getElementById('addAdminModal').style.display = 'none';
            document.getElementById('newAdminName').value = '';
            document.getElementById('newAdminEmail').value = '';
            document.getElementById('newAdminPass').value = '';
        }

        async function createAdditionalAdmin() {
            if (!requireAdmin()) return;
            
            const name = document.getElementById('newAdminName').value.trim();
            const email = document.getElementById('newAdminEmail').value.trim();
            const pass = document.getElementById('newAdminPass').value.trim();
            
            if (!name || !email || !pass) {
                showToast("الرجاء ملء جميع الحقول", "d");
                return;
            }
            
            if (!validateEmail(email)) {
                showToast("البريد الإلكتروني غير صالح", "d");
                return;
            }
            
            if (pass.length < 6) {
                showToast("كلمة المرور يجب أن تكون 6 أحرف على الأقل", "d");
                return;
            }

            try {
                const methods = await auth.fetchSignInMethodsForEmail(email);
                if (methods.length > 0) {
                    showToast("البريد الإلكتروني مستخدم بالفعل", "d");
                    return;
                }

                showLoading(true);
                showToast("جاري إنشاء حساب المدير...", "w");
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                const newUser = userCredential.user;
                
                await newUser.updateProfile({ displayName: name });
                await db_firestore.collection("users").doc(newUser.uid).set({ 
                    name, 
                    email, 
                    role: "admin", 
                    createdAt: new Date() 
                });

                db.emps[newUser.uid] = {
                    name, 
                    logs: [], 
                    finance: [], 
                    archive: [], 
                    leaves: [], 
                    debts: [],
                    rate: 5000, 
                    off: 0, 
                    isWorking: false, 
                    onBreak: false, 
                    totalMs: 0, 
                    lastStart: 0,
                    workStartTime: "09:00", 
                    latePenalty: "0"
                };
                await saveDataToFirestore();

                showLoading(false);
                showToast("✅ تم إضافة مدير جديد", "s");
                closeAddAdminModal();
                drawMgrEmps();
                drawEmployeeSelector();
            } catch (error) {
                showLoading(false);
                console.error("خطأ في إضافة مدير:", error);
                showToast("خطأ في إضافة المدير: " + error.message, "d");
            }
        }

        // ================================================
        // تهيئة النظام حسب المستخدم
        // ================================================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                showLoading(true);
                
                await loadDataFromFirestore();
                await syncUsersFromFirestore();

                try {
                    const userDoc = await db_firestore.collection("users").doc(user.uid).get();
                    currentUserRole = userDoc.exists ? userDoc.data().role : "employee";

                    if (!db.emps[user.uid]) {
                        db.emps[user.uid] = {
                            name: user.displayName || "موظف", 
                            logs: [], 
                            finance: [], 
                            archive: [], 
                            leaves: [], 
                            debts: [],
                            rate: 0, 
                            off: 0, 
                            isWorking: false, 
                            onBreak: false, 
                            totalMs: 0, 
                            lastStart: 0,
                            workStartTime: "", 
                            latePenalty: "0"
                        };
                        await saveDataToFirestore();
                    }

                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('registerScreen').style.display = 'none';
                    document.getElementById('firstAdminScreen').style.display = 'none';

                    applyTheme(db.config.theme || 'dark');
                    applyUI();
                    calculateGlobalStats();
                    updateAnnouncementUI();

                    // تحديث وقت آخر نشاط
                    sessionStorage.setItem('lastActivity', Date.now());

                    if (currentUserRole === 'admin') {
                        curId = null;
                        document.getElementById('selectionScreen').style.display = 'block';
                        document.getElementById('mainDashboard').style.display = 'none';
                        drawSelection();
                    } else {
                        curId = user.uid;
                        document.getElementById('selectionScreen').style.display = 'none';
                        document.getElementById('mainDashboard').style.display = 'block';
                        switchTab('home');
                        refreshDash();
                    }
                } catch (error) {
                    console.error("خطأ في تهيئة المستخدم:", error);
                    showToast("خطأ في تحميل بيانات المستخدم", "d");
                }
                
                showLoading(false);
            } else {
                await checkForExistingAdmin();
            }

            // مراقبة نشاط المستخدم
            document.addEventListener('click', () => {
                if (auth.currentUser) {
                    sessionStorage.setItem('lastActivity', Date.now());
                }
            });

            // التحقق من صلاحية الجلسة كل دقيقة
            setInterval(() => {
                const lastActivity = sessionStorage.getItem('lastActivity');
                if (lastActivity && Date.now() - lastActivity > 30 * 60 * 1000) {
                    logoutUser();
                    showToast("انتهت صلاحية الجلسة، الرجاء تسجيل الدخول مجدداً", "w");
                }
            }, 60000);
        });

        // ================================================
        // دوال الواجهة العامة
        // ================================================
        function rotateTheme() {
            const themes = ['dark', 'light', 'midnight', 'royal', 'forest'];
            let current = db.config.theme || 'dark';
            let next = themes[(themes.indexOf(current) + 1) % themes.length];
            applyTheme(next);
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            db.config.theme = theme;
            saveDataToFirestore();
            
            const icons = { 
                'dark': '🌙', 
                'light': '☀️', 
                'midnight': '🌌', 
                'royal': '👑', 
                'forest': '🌲' 
            };
            document.getElementById('themeIcon').innerText = icons[theme] || '🌓';
            document.getElementById('themeSelect').value = theme;
        }

        function applyUI() {
            const name = db.config.name;
            const logo = db.config.logo;
            document.getElementById('nameInp').value = name;
            document.getElementById('displayName').innerText = name;
            
            const img = logo ? `<img src="${logo}" style="width:100%;height:100%;object-fit:cover;">` : "💼";
            document.getElementById('mgrLogo').innerHTML = img;
            document.getElementById('displayLogo').innerHTML = img;
        }

        function confirmAndSave() {
            db.config.name = document.getElementById('nameInp').value;
            saveDataToFirestore();
            applyUI();
            showToast("تم حفظ الإعدادات", "s");
        }

        function previewLogo(i) {
            if (i.files && i.files[0]) {
                let r = new FileReader();
                r.onload = e => {
                    db.config.logo = e.target.result;
                    saveDataToFirestore();
                    applyUI();
                    showToast("تم تغيير الشعار", "s");
                };
                r.readAsDataURL(i.files[0]);
            }
        }

        function publishAnnouncement() {
            let msg = document.getElementById('announceInp').value.trim();
            if (!msg) {
                showToast("الرجاء إدخال نص التعميم", "d");
                return;
            }
            db.config.announcement = msg;
            saveDataToFirestore();
            showToast("تم نشر التعميم", "s");
            updateAnnouncementUI();
            document.getElementById('announceInp').value = '';
        }

        function clearAnnouncement() {
            db.config.announcement = null;
            saveDataToFirestore();
            showToast("تم حذف التعميم", "d");
            updateAnnouncementUI();
        }

        function updateAnnouncementUI() {
            const bar = document.getElementById('announcementBar');
            if (db.config.announcement) {
                bar.innerText = "📢 " + db.config.announcement;
                bar.style.display = 'block';
            } else {
                bar.style.display = 'none';
            }
        }

        function calculateGlobalStats() {
            let total = 0, active = 0, topName = "---", maxHours = 0;
            
            for (let id in db.emps) {
                let e = db.emps[id];
                if (e.isWorking) active++;
                
                let empMinutes = 0;
                if (e.logs) {
                    e.logs.forEach(l => { 
                        if (!l.isPaid) {
                            if (l.type === 'إكسل') {
                                empMinutes += Math.max(0, l.m - (parseFloat(e.off) || 0));
                            } else {
                                empMinutes += l.m;
                            }
                        }
                    });
                }
                
                let empFinance = 0;
                if (e.finance) {
                    e.finance.forEach(f => { 
                        if (!f.isPaid) empFinance += f.amount; 
                    });
                }
                
                total += (empMinutes / 60 * (parseFloat(e.rate) || 0)) + empFinance;
                
                if (empMinutes / 60 > maxHours) {
                    maxHours = empMinutes / 60;
                    topName = e.name;
                }
            }
            
            document.getElementById('statTotalCash').innerText = Math.floor(total).toLocaleString() + " د.ع";
            document.getElementById('statActiveCount').innerText = active;
            document.getElementById('statTopEmp').innerText = maxHours > 0 ? `${topName} (${Math.floor(maxHours)}س)` : "---";
        }

        // ================================================
        // دوال الموظف
        // ================================================
        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.add('active');
            
            document.querySelectorAll('.taskbar-item').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}Btn`).classList.add('active');
        }

        async function startShift() {
            if (!requireEmployee()) return;
            
            let e = db.emps[curId];
            
            e.totalMs = 0;
            e.isWorking = true;
            e.onBreak = false;
            e.lastStart = Date.now();
            
            const now = new Date();
            const fullDateTime = now.toLocaleDateString('ar-EG') + " - " + now.toLocaleTimeString('ar-EG');
            
            const empStartTime = e.workStartTime || db.config.workStartTime || "08:00";
            const empPenalty = parseFloat(e.latePenalty) || 0;
            
            if (empStartTime && empPenalty > 0) {
                const [sh, sm] = empStartTime.split(':').map(Number);
                const sched = new Date(); 
                sched.setHours(sh, sm, 0);

                if (Date.now() > sched.getTime()) {
                    if (!e.finance) e.finance = [];
                    e.finance.unshift({ 
                        amount: -empPenalty, 
                        reason: "غرامة تأخير", 
                        date: fullDateTime, 
                        isPaid: false 
                    });
                    showToast(`تم تسجيل غرامة تأخير: ${empPenalty} د.ع`, "d");
                }
            }
            
            await saveDataToFirestore();
            refreshDash();
            showToast("تم بدء الدوام", "s");
        }

        async function stopShift() {
            if (!requireEmployee()) return;
            
            let e = db.emps[curId];
            
            if (!e.onBreak && e.lastStart) {
                e.totalMs += (Date.now() - e.lastStart);
            }
            
            let dur = e.totalMs / 60000;
            
            if (dur > 0.1) {
                if (!e.logs) e.logs = [];
                e.logs.unshift({ 
                    m: dur, 
                    d: new Date().toLocaleDateString('ar-EG'), 
                    type: 'يدوي', 
                    isPaid: false 
                });
                
                showToast(`✅ تم تسجيل ${Math.floor(dur)} دقيقة و ${Math.round((dur % 1) * 60)} ثانية`, "s");
            }
            
            e.isWorking = false;
            e.onBreak = false;
            e.totalMs = 0;
            e.lastStart = 0;
            
            await saveDataToFirestore();
            refreshDash();
        }

        async function toggleBreak() {
            if (!requireEmployee()) return;
            
            let e = db.emps[curId];
            if (!e || !e.isWorking) return;
            
            if (e.onBreak) {
                e.lastStart = Date.now();
                e.onBreak = false;
                showToast("عدت من الاستراحة", "s");
            } else {
                e.totalMs += (Date.now() - e.lastStart);
                e.onBreak = true;
                showToast("في استراحة", "w");
            }
            
            await saveDataToFirestore();
            refreshDash();
        }

        function refreshDash() {
            if (!requireEmployee()) return;
            
            let e = db.emps[curId];
            if (!e) return;
            
            document.getElementById('fNameHome').innerText = e.name;
            
            if (timer) clearInterval(timer);
            
            if (e.isWorking) {
                timer = setInterval(tick, 1000);
            }
            
            tick();
            drawLogs();
            drawArchive();
            drawMyLeaves();
            
            calculateTotalSalary(curId);
        }

        function calculateTotalSalary(empId = curId) {
            if (!empId || !db.emps[empId]) return 0;
            
            let e = db.emps[empId];
            
            let totalMinutes = 0;
            if (e.logs && e.logs.length > 0) {
                totalMinutes = e.logs.reduce((sum, log) => {
                    if (!log.isPaid) {
                        let minutes = log.m;
                        if (log.type === 'إكسل') {
                            minutes = Math.max(0, minutes - (parseFloat(e.off) || 0));
                        }
                        return sum + minutes;
                    }
                    return sum;
                }, 0);
            }
            
            let salaryFromTime = (totalMinutes / 60) * (parseFloat(e.rate) || 0);
            
            let totalFinance = 0;
            if (e.finance && e.finance.length > 0) {
                totalFinance = e.finance.reduce((sum, f) => {
                    return f.isPaid ? sum : sum + (f.amount || 0);
                }, 0);
            }
            
            let totalDebtInstallments = 0;
            if (e.debts && e.debts.length > 0) {
                totalDebtInstallments = e.debts.reduce((sum, d) => {
                    if (d.remaining > 0) {
                        return sum + Math.min(d.remaining, d.installment || 0);
                    }
                    return sum;
                }, 0);
            }
            
            let finalSalary = salaryFromTime + totalFinance - totalDebtInstallments;
            
            if (empId === curId) {
                document.getElementById('fMoneyHome').innerText = 
                    Math.floor(finalSalary).toLocaleString() + " د.ع";
                
                let hours = Math.floor(totalMinutes / 60);
                let minutes = Math.round(totalMinutes % 60);
                document.getElementById('fTimeHome').innerText = hours + "س " + minutes + "د";
            }
            
            return finalSalary;
        }

        function tick() {
            if (!requireEmployee()) return;
            
            let e = db.emps[curId];
            if (!e) return;
            
            let curMs = 0;
            if (e.isWorking && !e.onBreak && e.lastStart) {
                curMs = (Date.now() - e.lastStart);
            }
            
            let ms = e.totalMs + curMs;
            
            let s = Math.floor(ms / 1000);
            let h = Math.floor(s / 3600);
            let m = Math.floor((s % 3600) / 60);
            let sc = s % 60;
            document.getElementById('clock').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sc).padStart(2,'0')}`;
            
            document.getElementById('startBtn').style.display = e.isWorking ? 'none' : 'block';
            document.getElementById('activeControls').style.display = e.isWorking ? 'flex' : 'none';
        }

        function drawLogs() {
            if (!requireEmployee()) return;
            
            let e = db.emps[curId];
            if (!e) return;
            
            let hL = "", hF = "", hD = "";
            
            if (e.logs && e.logs.length > 0) {
                e.logs.forEach((l, i) => {
                    if (l.isPaid) return;
                    let minutes = l.type === 'إكسل' ? Math.max(0, l.m - (parseFloat(e.off) || 0)) : l.m;
                    let hours = Math.floor(minutes / 60);
                    let mins = Math.round(minutes % 60);
                    
                    hL += `<div style="background:var(--card); border:1px solid var(--border); border-right:8px solid var(--p); border-radius:18px; padding:15px; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between;">
                            <b>${hours}س ${mins}د</b>
                            <button onclick="deleteLog(${i})" style="background:var(--border); border:none; color:var(--text); padding:8px; border-radius:10px;">🗑️</button>
                        </div>
                        <small>📅 ${l.d} (${l.type})</small>
                    </div>`;
                });
            }
            
            if (e.finance && e.finance.length > 0) {
                e.finance.forEach((f, i) => {
                    if (f.isPaid) return;
                    hF += `<div style="display:flex; justify-content:space-between; background:var(--inp-bg); padding:12px; border-radius:12px; margin-bottom:8px; border-right:6px solid ${f.amount>0?'var(--s)':'var(--d)'};">
                        <div>
                            <span>${f.amount>0?'+':''}${f.amount} | ${f.reason}</span>
                            <br><small>📅 ${f.date}</small>
                        </div>
                        <button onclick="deleteFinance(${i})" style="background:transparent; border:none; color:var(--d); font-size:18px;">🗑️</button>
                    </div>`;
                });
            }
            
            if (e.debts && e.debts.length > 0) {
                e.debts.forEach(d => { 
                    if (d.remaining > 0) {
                        hD += `<div style="background:var(--inp-bg); padding:8px; border-radius:8px; margin-bottom:5px;">
                            💰 ${d.reason}: ${d.remaining} د.ع
                        </div>`;
                    }
                });
            }
            
            document.getElementById('logsBox').innerHTML = hL || "<p style='text-align:center; color:gray;'>لا توجد سجلات دوام</p>";
            document.getElementById('financialLogs').innerHTML = hF || "<p style='text-align:center; color:gray;'>لا توجد عمليات مالية</p>";
            document.getElementById('activeDebtsBox').innerHTML = hD || "";
        }

        async function deleteLog(index) {
            if (!requireEmployee()) return;
            
            if (confirm("هل أنت متأكد من حذف هذا السجل؟")) {
                db.emps[curId].logs.splice(index, 1);
                await saveDataToFirestore();
                drawLogs();
                calculateTotalSalary();
                showToast("تم حذف السجل", "s");
            }
        }

        async function deleteFinance(index) {
            if (!requireEmployee()) return;
            
            if (confirm("هل أنت متأكد من حذف هذه العملية؟")) {
                db.emps[curId].finance.splice(index, 1);
                await saveDataToFirestore();
                drawLogs();
                calculateTotalSalary();
                showToast("تم حذف العملية", "s");
            }
        }

        function requestLeave() {
            if (!requireEmployee()) return;
            
            let e = db.emps[curId];
            let d = document.getElementById('leaveDate').value;
            let t = document.getElementById('leaveType').value;
            
            if (!d) {
                showToast("الرجاء اختيار تاريخ الإجازة", "d");
                return;
            }
            
            if (!e.leaves) e.leaves = [];
            e.leaves.unshift({ 
                id: Date.now(), 
                date: d, 
                type: t, 
                status: 'pending' 
            });
            
            saveDataToFirestore();
            drawMyLeaves();
            showToast("تم إرسال الطلب", "s");
            document.getElementById('leaveDate').value = '';
        }

        function drawMyLeaves() {
            if (!requireEmployee()) return;
            
            let e = db.emps[curId];
            if (!e || !e.leaves) return;
            
            let h = "";
            let sM = { 'pending': '⏳', 'approved': '✅', 'rejected': '❌' };
            
            e.leaves.forEach(l => {
                h += `<div style="display:flex; justify-content:space-between; background:var(--inp-bg); padding:10px; border-radius:12px; margin-bottom:5px;">
                    📅 ${l.date} (${l.type}) <span>${sM[l.status]}</span>
                </div>`;
            });
            
            document.getElementById('myLeavesStatus').innerHTML = h || "<p style='color:#94a3b8;'>لا توجد طلبات إجازة</p>";
        }

        function toggleInstallmentField() {
            document.getElementById('installAmount').style.display = 
                document.getElementById('moneyType').value === 'installment' ? 'block' : 'none';
        }

        async function addFinancial() {
            if (!requireEmployee()) return;
            
            let e = db.emps[curId];
            let amt = parseFloat(document.getElementById('moneyAmount').value);
            let type = document.getElementById('moneyType').value;
            let reason = document.getElementById('moneyReason').value;
            
            if (!amt || amt <= 0) {
                showToast("الرجاء إدخال مبلغ صحيح", "d");
                return;
            }

            const fullDateTime = new Date().toLocaleDateString('ar-EG') + " - " + new Date().toLocaleTimeString('ar-EG');

            if (type === 'installment') {
                let inst = parseFloat(document.getElementById('installAmount').value);
                if (!inst || inst <= 0) {
                    showToast("الرجاء إدخال قيمة القسط", "d");
                    return;
                }
                if (!e.debts) e.debts = [];
                e.debts.push({ 
                    id: Date.now(), 
                    total: amt, 
                    remaining: amt, 
                    installment: inst, 
                    reason: reason || "سلفة", 
                    date: fullDateTime 
                });
                showToast(`تم إضافة سلفة مقسطة: ${amt} د.ع`, "s");
            } else {
                if (!e.finance) e.finance = [];
                let finalAmount = (type === 'bonus' ? amt : -amt);
                e.finance.unshift({ 
                    amount: finalAmount, 
                    reason: reason || type, 
                    date: fullDateTime, 
                    isPaid: false 
                });
                showToast(`تم إضافة ${type === 'bonus' ? 'مكافأة' : 'استقطاع'}: ${finalAmount} د.ع`, "s");
            }
            
            await saveDataToFirestore();
            
            document.getElementById('moneyAmount').value = "";
            document.getElementById('moneyReason').value = "";
            document.getElementById('installAmount').value = "";
            
            drawLogs();
            calculateTotalSalary();
        }

        // ================================================
        // دوال المدير
        // ================================================
        function selectFromMgr(id) {
            if (!requireAdmin()) return;
            
            curId = id;
            closeMgr();
            document.getElementById('selectionScreen').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
            refreshDash();
            showToast(`أنت الآن تتصفح بيانات ${db.emps[id].name}`, 'p');
        }

        function drawSelection() {
            let t = document.getElementById('searchBar').value.toLowerCase();
            let h = "";
            
            for (let id in db.emps) {
                if (db.emps[id].name.toLowerCase().includes(t)) {
                    let s = db.emps[id].isWorking ? '<br><small style="color:var(--s)">● مداوم</small>' : '';
                    h += `<div onclick="selectFromMgr('${id}')" class="emp-grid-item"><b>${db.emps[id].name}</b>${s}</div>`;
                }
            }
            document.getElementById('empGrid').innerHTML = h || "<p style='text-align:center;'>لا يوجد موظفين</p>";
        }

        function openEditModal(id) {
            if (!requireAdmin()) return;
            
            editingEmpId = id;
            document.getElementById('editEmpNameInp').value = db.emps[id].name;
            
            db_firestore.collection("users").doc(id).get().then(doc => {
                document.getElementById('editEmpEmailInp').value = doc.exists ? doc.data().email || '' : '';
            }).catch(() => document.getElementById('editEmpEmailInp').value = '');
            
            document.getElementById('editEmpPassInp').value = '';
            document.getElementById('editEmpModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editEmpModal').style.display = 'none';
            editingEmpId = null;
        }

        async function saveNewEmpData() {
            if (!requireAdmin()) return;
            
            let newName = document.getElementById('editEmpNameInp').value.trim();
            let newEmail = document.getElementById('editEmpEmailInp').value.trim();
            
            if (!newName || !newEmail) {
                showToast("الرجاء إدخال الاسم والبريد", "d");
                return;
            }
            
            if (!validateEmail(newEmail)) {
                showToast("البريد الإلكتروني غير صالح", "d");
                return;
            }

            if (editingEmpId) {
                try {
                    showLoading(true);
                    
                    db.emps[editingEmpId].name = newName;
                    await saveDataToFirestore();

                    const user = auth.currentUser;
                    if (user && user.uid === editingEmpId) {
                        await user.updateProfile({ displayName: newName });
                        let newPass = document.getElementById('editEmpPassInp').value.trim();
                        if (newPass && newPass.length >= 6) {
                            await user.updatePassword(newPass);
                        }
                    }
                    
                    await db_firestore.collection("users").doc(editingEmpId).update({ 
                        name: newName, 
                        email: newEmail 
                    });
                    
                    showLoading(false);
                    showToast("تم تحديث البيانات", "s");
                    
                    drawMgrEmps();
                    drawSelection();
                    drawEmployeeSelector();
                    closeEditModal();
                } catch (e) {
                    showLoading(false);
                    console.error("خطأ في تحديث البيانات:", e);
                    showToast("خطأ في تحديث البيانات", "d");
                }
            }
        }

        async function deleteEmployee(empId) {
            if (!requireAdmin()) return;
            
            if (!confirm('⚠️ هل أنت متأكد من حذف هذا الموظف؟ لا يمكن التراجع عن هذا الإجراء')) {
                return;
            }

            try {
                showLoading(true);
                showToast("جاري الحذف...", "w");
                
                await db_firestore.collection("users").doc(empId).delete();
                delete db.emps[empId];
                await saveDataToFirestore();
                
                showLoading(false);
                showToast("✅ تم حذف الموظف", "s");
                
                drawMgrEmps();
                drawSelection();
                drawEmployeeSelector();
                
                if (auth.currentUser && auth.currentUser.uid === empId) {
                    showToast("تم حذف حسابك، سيتم تسجيل الخروج", "w");
                    setTimeout(() => logoutUser(), 2000);
                }
            } catch (error) {
                showLoading(false);
                console.error("خطأ في حذف الموظف:", error);
                showToast("خطأ في الحذف: " + error.message, "d");
            }
        }

        async function addNewEmp() {
            if (!requireAdmin()) return;
            
            const empName = document.getElementById('addEmpName').value.trim();
            const empEmail = document.getElementById('addEmpEmail').value.trim();
            const empPass = document.getElementById('addEmpPass').value.trim();
            
            if (!empName || !empEmail || !empPass) {
                showToast("الرجاء ملء جميع الحقول", "d");
                return;
            }
            
            if (!validateEmail(empEmail)) {
                showToast("البريد الإلكتروني غير صالح", "d");
                return;
            }
            
            if (empPass.length < 6) {
                showToast("كلمة المرور يجب أن تكون 6 أحرف على الأقل", "d");
                return;
            }

            try {
                const methods = await auth.fetchSignInMethodsForEmail(empEmail);
                if (methods.length > 0) {
                    showToast("البريد الإلكتروني مستخدم بالفعل", "d");
                    return;
                }

                showLoading(true);
                showToast("جاري إنشاء الحساب...", "w");
                
                const userCredential = await auth.createUserWithEmailAndPassword(empEmail, empPass);
                const newUser = userCredential.user;
                
                await newUser.updateProfile({ displayName: empName });
                await db_firestore.collection("users").doc(newUser.uid).set({ 
                    name: empName, 
                    email: empEmail, 
                    role: "employee", 
                    createdAt: new Date() 
                });

                db.emps[newUser.uid] = {
                    name: empName, 
                    logs: [], 
                    finance: [], 
                    archive: [], 
                    leaves: [], 
                    debts: [],
                    rate: 0, 
                    off: 0, 
                    isWorking: false, 
                    onBreak: false, 
                    totalMs: 0, 
                    lastStart: 0,
                    workStartTime: "", 
                    latePenalty: "0"
                };
                await saveDataToFirestore();

                document.getElementById('quickAddSection').style.display = 'none';
                
                showLoading(false);
                showToast("✅ تم إضافة الموظف", "s");
                
                document.getElementById('addEmpName').value = '';
                document.getElementById('addEmpEmail').value = '';
                document.getElementById('addEmpPass').value = '';
                
                drawMgrEmps();
                drawSelection();
                drawEmployeeSelector();
            } catch (error) {
                showLoading(false);
                console.error("خطأ في إضافة الموظف:", error);
                showToast("خطأ: " + error.message, "d");
            }
        }

        function openAdminPanel() {
            if (!requireAdmin()) return;
            
            refreshAllMgrData();
            document.getElementById('mgrModal').style.display = 'block';
            switchMgrTab('home');
        }

        function refreshAllMgrData() {
            updateMgrStats();
            drawMgrEmps();
            drawMgrLeaves();
            checkAdminAlerts();
            populateSettingsEmpSelect();
            
            if (auth.currentUser) {
                document.getElementById('mgrUserName').innerText = auth.currentUser.displayName || 'المدير';
            }
        }

        function switchMgrTab(tabId) {
            document.querySelectorAll('.mgr-tab-pane').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`mgrTab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.add('active');
            
            document.querySelectorAll('.mgr-taskbar-item').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`mgrTab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}Btn`).classList.add('active');
            
            if (tabId === 'reports') {
                setTimeout(updateCharts, 300);
                updateReportStats();
                updatePerformanceCards();
                updateHeatmapGrid();
            } else if (tabId === 'leaves') {
                drawMgrLeaves();
            } else if (tabId === 'employees') {
                drawMgrEmps();
            } else if (tabId === 'settings') {
                populateSettingsEmpSelect();
                if (!document.getElementById('settingsEmpSelect').value) {
                    document.getElementById('empSettingsFields').style.display = 'none';
                }
            } else if (tabId === 'finance') {
                // تحديث أرقام المالية عند فتح التبويب
                updateMgrStats();
            }
        }

        function closeMgr() {
            document.getElementById('mgrModal').style.display = 'none';
        }

        function updateMgrStats() {
            let totalEmployees = Object.keys(db.emps).length;
            let activeNow = 0;
            let totalSalaries = 0;
            let pendingLeaves = 0;
            let totalDebts = 0;
            
            for (let id in db.emps) {
                let e = db.emps[id];
                if (e.isWorking) activeNow++;
                
                let empMinutes = 0;
                if (e.logs) {
                    e.logs.forEach(l => { 
                        if (!l.isPaid) {
                            if (l.type === 'إكسل') {
                                empMinutes += Math.max(0, l.m - (parseFloat(e.off)||0));
                            } else {
                                empMinutes += l.m;
                            }
                        }
                    });
                }
                
                let empFinance = 0;
                if (e.finance) {
                    e.finance.forEach(f => { 
                        if (!f.isPaid) empFinance += f.amount; 
                    });
                }
                
                totalSalaries += (empMinutes / 60 * (parseFloat(e.rate)||0)) + empFinance;
                
                if (e.leaves) e.leaves.forEach(l => { 
                    if (l.status === 'pending') pendingLeaves++; 
                });
                
                if (e.debts) e.debts.forEach(d => { 
                    totalDebts += d.remaining || 0; 
                });
            }
            
            // تحديث جميع القيم
            document.getElementById('statTotalEmployees').innerText = totalEmployees;
            document.getElementById('statActiveNow').innerText = activeNow;
            document.getElementById('statTotalSalaries').innerText = Math.floor(totalSalaries).toLocaleString() + " د.ع";
            document.getElementById('statPendingLeaves').innerText = pendingLeaves;
            
            // تحديث بطاقات المالية
            document.getElementById('financeTotalSalaries').innerText = Math.floor(totalSalaries).toLocaleString() + " د.ع";
            document.getElementById('financeTotalDebts').innerText = Math.floor(totalDebts).toLocaleString() + " د.ع";
            
            document.getElementById('statTotalEmployeesMini').innerText = totalEmployees;
        }

        function drawMgrEmps() {
            let h = "";
            
            for (let id in db.emps) {
                let icon = id === auth.currentUser?.uid ? "👑" : "👤";
                h += `<div class="emp-item-modern">
                        <div class="emp-info" onclick="selectFromMgr('${id}')">
                            <div class="emp-avatar">${icon}</div>
                            <div class="emp-details">
                                <h4>${db.emps[id].name}</h4>
                                <small>${id === auth.currentUser?.uid ? 'أنت' : ''}</small>
                            </div>
                        </div>
                        <div class="emp-actions-vertical">
                            <button onclick="openEditModal('${id}')" class="emp-action-btn" title="تعديل">✏️</button>
                            <button onclick="deleteEmployee('${id}')" class="emp-action-btn delete" title="حذف">🗑️</button>
                        </div>
                    </div>`;
            }
            
            document.getElementById('mgrEmpList').innerHTML = h || "<p style='text-align:center;'>لا يوجد موظفين</p>";
            document.getElementById('statTotalEmployeesMini').innerText = Object.keys(db.emps).length;
        }

        function drawMgrLeaves() {
            let h = "";
            
            for (let id in db.emps) {
                let e = db.emps[id];
                if (e.leaves) {
                    e.leaves.forEach((l) => {
                        if (l.status === 'pending') {
                            h += `<div class="leave-request-item">
                                <div class="leave-info">
                                    <strong>${e.name}</strong>
                                    <small>📅 ${l.date} (${l.type})</small>
                                </div>
                                <div class="leave-actions">
                                    <button onclick="processLeave('${id}', ${l.id}, 'approved')" class="leave-action-btn approve">
                                        ✅ موافقة
                                    </button>
                                    <button onclick="processLeave('${id}', ${l.id}, 'rejected')" class="leave-action-btn reject">
                                        ❌ رفض
                                    </button>
                                </div>
                            </div>`;
                        }
                    });
                }
            }
            
            document.getElementById('mgrLeaveRequests').innerHTML = h || "<p style='text-align:center; color:#94a3b8;'>لا يوجد طلبات معلقة</p>";
        }

        async function processLeave(eid, lid, stat) {
            if (!requireAdmin()) return;
            
            let e = db.emps[eid];
            let l = e.leaves.find(x => x.id === lid);
            
            if (l) {
                l.status = stat;
                await saveDataToFirestore();
                drawMgrLeaves();
                updateMgrStats();
                showToast(`تم ${stat === 'approved' ? 'قبول' : 'رفض'} الإجازة`, "s");
            }
        }

        function checkAdminAlerts() {
            let listHtml = "";
            const now = new Date();
            
            for (let id in db.emps) {
                let e = db.emps[id];
                const empStartTime = e.workStartTime || db.config.workStartTime || "08:00";
                const [startH, startM] = empStartTime.split(':').map(Number);
                const startTimeToday = new Date(); 
                startTimeToday.setHours(startH, startM, 0);
                
                if (!e.isWorking && now > startTimeToday) { 
                    listHtml += `<div style="color:var(--d); padding:8px; margin-bottom:5px; background:rgba(239,68,68,0.1); border-radius:10px;">
                        ● ${e.name}: لم يحضر بعد (موعده: ${empStartTime})
                    </div>`;
                }
            }
            
            document.getElementById('adminAlertsList').innerHTML = listHtml || "<div style='color:var(--s); text-align:center;'>✅ جميع الموظفين في الموعد</div>";
        }

        // ================================================
        // دوال إعدادات الموظف
        // ================================================
        function populateSettingsEmpSelect() {
            const select = document.getElementById('settingsEmpSelect');
            let options = '<option value="">-- اختر موظفاً --</option>';
            
            for (let id in db.emps) {
                options += `<option value="${id}">${db.emps[id].name}</option>`;
            }
            
            select.innerHTML = options;
        }

        function loadSelectedEmpSettings() {
            const selectedId = document.getElementById('settingsEmpSelect').value;
            
            if (!selectedId) {
                document.getElementById('empSettingsFields').style.display = 'none';
                return;
            }
            
            const e = db.emps[selectedId];
            if (e) {
                document.getElementById('rateInp').value = e.rate || '';
                document.getElementById('offInp').value = e.off || '';
                document.getElementById('empWorkStart').value = e.workStartTime || '';
                document.getElementById('empLatePenalty').value = e.latePenalty || '';
                document.getElementById('empSettingsFields').style.display = 'block';
            }
        }

        async function updateSettings() {
            if (!requireAdmin()) return;
            
            const selectedId = document.getElementById('settingsEmpSelect').value;
            if (!selectedId) return;
            
            let e = db.emps[selectedId];
            e.rate = parseFloat(document.getElementById('rateInp').value) || 0;
            e.off = parseFloat(document.getElementById('offInp').value) || 0;
            e.workStartTime = document.getElementById('empWorkStart').value;
            e.latePenalty = document.getElementById('empLatePenalty').value;
            
            await saveDataToFirestore();
            showToast(`تم حفظ إعدادات ${e.name}`, "s");
            
            if (selectedId === curId) {
                calculateTotalSalary();
            }
        }

        // ================================================
        // دوال التقارير المحسنة
        // ================================================
        function filterAnalytics(period, event) {
            if (!event) return;
            
            document.querySelectorAll('.analytics-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            showToast(`تم تغيير الفترة إلى ${period === 'week' ? 'أسبوعي' : period === 'month' ? 'شهري' : 'سنوي'}`, 's');
            
            updateAnalyticsData(period);
        }

        function updateAnalyticsData(period) {
            const kpiAttendance = document.getElementById('kpiAttendance');
            const kpiProductivity = document.getElementById('kpiProductivity');
            
            if (period === 'week') {
                kpiAttendance.innerText = '95%';
                kpiProductivity.innerText = '82%';
            } else if (period === 'month') {
                kpiAttendance.innerText = '98%';
                kpiProductivity.innerText = '87%';
            } else {
                kpiAttendance.innerText = '92%';
                kpiProductivity.innerText = '85%';
            }
        }

        function updateReportStats() {
            let totalEmployees = Object.keys(db.emps).length;
            let totalHours = 0;
            let totalSalaries = 0;
            let totalDebts = 0;
            let totalLeavesThisMonth = 0;
            let lateCount = 0;
            
            const now = new Date();
            const currentMonth = now.getMonth();
            
            for (let id in db.emps) {
                let e = db.emps[id];
                
                if (e.logs) {
                    e.logs.forEach(l => {
                        if (!l.isPaid) {
                            totalHours += l.m / 60;
                        }
                    });
                }
                
                let empMinutes = 0;
                if (e.logs) {
                    e.logs.forEach(l => {
                        if (!l.isPaid) {
                            empMinutes += l.m;
                        }
                    });
                }
                let empFinance = 0;
                if (e.finance) {
                    e.finance.forEach(f => {
                        if (!f.isPaid) empFinance += f.amount;
                    });
                }
                totalSalaries += (empMinutes / 60 * (parseFloat(e.rate)||0)) + empFinance;
                
                if (e.debts) {
                    e.debts.forEach(d => {
                        totalDebts += d.remaining || 0;
                    });
                }
                
                if (e.leaves) {
                    e.leaves.forEach(l => {
                        let leaveMonth = new Date(l.date).getMonth();
                        if (leaveMonth === currentMonth) {
                            totalLeavesThisMonth++;
                        }
                    });
                }
                
                const empStartTime = e.workStartTime || db.config.workStartTime || "08:00";
                if (e.logs && e.logs.length > 0) {
                    let lateDays = e.logs.filter(l => l.type === 'تأخير').length;
                    lateCount += lateDays;
                }
            }
            
            document.getElementById('reportStatTotal').innerText = totalEmployees;
            document.getElementById('reportStatHours').innerHTML = Math.floor(totalHours) + ' <small>ساعة</small>';
            document.getElementById('reportStatSalaries').innerText = Math.floor(totalSalaries).toLocaleString() + ' د.ع';
            document.getElementById('reportStatDebts').innerText = Math.floor(totalDebts).toLocaleString() + ' د.ع';
            document.getElementById('reportStatLeaves').innerText = totalLeavesThisMonth;
            document.getElementById('reportStatLate').innerText = lateCount;
            
            let attendanceRate = totalEmployees > 0 ? Math.floor((totalEmployees - lateCount) / totalEmployees * 100) : 0;
            document.getElementById('kpiAttendance').innerText = attendanceRate + '%';
            document.getElementById('kpiProductivity').innerText = '87%';
            document.getElementById('kpiOvertime').innerText = '42';
            document.getElementById('kpiSatisfaction').innerText = '4.5';
        }

        function updatePerformanceCards() {
            const container = document.getElementById('performanceCards');
            let html = '';
            
            let employees = [];
            for (let id in db.emps) {
                let e = db.emps[id];
                let hours = 0;
                if (e.logs) {
                    e.logs.forEach(l => {
                        hours += l.m / 60;
                    });
                }
                employees.push({ id, name: e.name, hours, rate: e.rate || 0 });
            }
            
            employees.sort((a, b) => b.hours - a.hours);
            
            employees.slice(0, 3).forEach((emp, index) => {
                let progress = Math.min(100, (emp.hours / 200) * 100);
                let medal = index === 0 ? '🥇' : index === 1 ? '🥈' : '🥉';
                
                html += `
                    <div class="performance-card">
                        <div class="performance-header">
                            <div class="performance-avatar">${medal}</div>
                            <div class="performance-info">
                                <h5>${emp.name}</h5>
                                <small>${emp.hours.toFixed(1)} ساعة عمل</small>
                            </div>
                        </div>
                        <div class="performance-stats">
                            <div class="performance-stat-item">
                                <div class="performance-stat-label">ساعات</div>
                                <div class="performance-stat-value">${emp.hours.toFixed(1)}</div>
                            </div>
                            <div class="performance-stat-item">
                                <div class="performance-stat-label">المستحق</div>
                                <div class="performance-stat-value">${Math.floor(emp.hours * (emp.rate || 0)).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="performance-progress">
                            <div class="performance-progress-bar" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p style="text-align:center; color:#94a3b8;">لا توجد بيانات كافية</p>';
        }

        function updateHeatmapGrid() {
            const container = document.getElementById('heatmapGrid');
            let html = '';
            
            if (!curId) {
                let allEmployees = Object.keys(db.emps).slice(0, 5);
                
                allEmployees.forEach(empId => {
                    let e = db.emps[empId];
                    let row = `<div class="heatmap-row">`;
                    row += `<div class="heatmap-label">${e.name}</div>`;
                    row += `<div class="heatmap-bars">`;
                    
                    for (let i = 0; i < 10; i++) {
                        let date = new Date();
                        date.setDate(date.getDate() - i);
                        let dateStr = date.toLocaleDateString('ar-EG');
                        
                        let wasPresent = e.logs && e.logs.some(l => l.d === dateStr);
                        let intensity = wasPresent ? '0.9' : '0.2';
                        let color = wasPresent ? `rgba(16, 185, 129, ${intensity})` : `rgba(100, 116, 139, ${intensity})`;
                        
                        row += `<div class="heatmap-bar" style="background: ${color};" data-tooltip="${dateStr}"></div>`;
                    }
                    
                    row += `</div></div>`;
                    html += row;
                });
            } else {
                let e = db.emps[curId];
                let row = `<div class="heatmap-row">`;
                row += `<div class="heatmap-label">${e.name}</div>`;
                row += `<div class="heatmap-bars">`;
                
                for (let i = 29; i >= 0; i--) {
                    let date = new Date();
                    date.setDate(date.getDate() - i);
                    let dateStr = date.toLocaleDateString('ar-EG');
                    
                    let wasPresent = e.logs && e.logs.some(l => l.d === dateStr);
                    let intensity = wasPresent ? '0.9' : '0.2';
                    let color = wasPresent ? `rgba(16, 185, 129, ${intensity})` : `rgba(100, 116, 139, ${intensity})`;
                    
                    row += `<div class="heatmap-bar" style="background: ${color};" data-tooltip="${dateStr}"></div>`;
                }
                
                row += `</div></div>`;
                html = row;
            }
            
            container.innerHTML = html || '<p style="text-align:center; color:#94a3b8;">لا توجد بيانات كافية</p>';
        }

        async function settleAccount() {
            if (!requireEmployee()) return;
            
            let e = db.emps[curId];
            if (!e) return;
            
            let curMin = 0;
            if (e.logs) {
                e.logs.forEach(l => { 
                    if (!l.isPaid) {
                        if (l.type === 'إكسل') {
                            curMin += Math.max(0, l.m - (parseFloat(e.off)||0));
                        } else {
                            curMin += l.m;
                        }
                    }
                });
            }
            
            let curFin = 0;
            if (e.finance) {
                e.finance.forEach(f => { 
                    if (!f.isPaid) curFin += f.amount; 
                });
            }

            let base = (curMin / 60) * (parseFloat(e.rate) || 0) + curFin;
            
            let inst = 0;
            if (e.debts) {
                e.debts.forEach(d => { 
                    if (d.remaining > 0) inst += Math.min(d.remaining, d.installment || 0); 
                });
            }

            let final = base - inst;
            
            if (confirm(`💰 الصافي النهائي: ${Math.floor(final).toLocaleString()} د.ع\nهل تريد تصفية الحساب؟`)) {
                if (e.debts) {
                    e.debts.forEach(d => { 
                        if (d.remaining > 0) d.remaining -= Math.min(d.remaining, d.installment || 0); 
                    });
                }
                
                if (!e.archive) e.archive = [];
                e.archive.unshift({ 
                    date: new Date().toLocaleDateString('ar-EG'), 
                    amount: Math.floor(final),
                    details: `تصفية حساب - الوقت: ${Math.floor(curMin/60)}س ${Math.round(curMin%60)}د`
                });
                
                lastSettleMsg = `🧾 كشف راتب: ${e.name} | صافي المستحقات: ${Math.floor(final).toLocaleString()} د.ع`;
                
                // إظهار زر الواتساب
                const waBtn = document.getElementById('waBtn');
                waBtn.style.display = 'block';
                waBtn.classList.add('finance-action-btn');
                
                if (e.logs) e.logs.forEach(l => l.isPaid = true);
                if (e.finance) e.finance.forEach(f => f.isPaid = true);
                
                await saveDataToFirestore();
                refreshDash();
                showToast("تمت تصفية الحساب بنجاح", "s");
            }
        }

        function generatePDF() {
            if (!requireEmployee()) return;
            
            let e = db.emps[curId];
            
            let curMin = 0, bonus = 0, deduct = 0;
            if (e.logs) {
                e.logs.forEach(l => { 
                    if (!l.isPaid) {
                        if (l.type === 'إكسل') {
                            curMin += Math.max(0, l.m - (parseFloat(e.off)||0));
                        } else {
                            curMin += l.m;
                        }
                    }
                });
            }
            
            if (e.finance) {
                e.finance.forEach(f => { 
                    if (!f.isPaid) { 
                        if (f.amount > 0) bonus += f.amount; 
                        else deduct += Math.abs(f.amount); 
                    } 
                });
            }

            let inst = 0;
            if (e.debts) {
                e.debts.forEach(d => { 
                    if (d.remaining > 0) inst += Math.min(d.remaining, d.installment || 0); 
                });
            }

            let basePay = (curMin / 60) * (parseFloat(e.rate) || 0);
            let finalPay = basePay + bonus - deduct - inst;

            document.getElementById('receiptCompanyName').innerText = db.config.name;
            document.getElementById('rEmpName').innerText = e.name;
            document.getElementById('receiptDate').innerText = new Date().toLocaleDateString('ar-EG', { month:'long', year:'numeric' });
            document.getElementById('rEmpTime').innerText = Math.floor(curMin/60) + " ساعة و " + Math.round(curMin%60) + " دقيقة";
            document.getElementById('rEmpBase').innerText = Math.floor(basePay).toLocaleString() + " د.ع";
            document.getElementById('rEmpBonus').innerText = "+" + bonus.toLocaleString() + " د.ع";
            document.getElementById('rEmpDeduct').innerText = "-" + (deduct + inst).toLocaleString() + " د.ع";
            document.getElementById('rEmpFinal').innerText = Math.floor(finalPay).toLocaleString() + " د.ع";

            const logo = db.config.logo;
            document.getElementById('receiptLogoPlace').innerHTML = logo ? `<img src="${logo}" style="width:80px; height:80px; border-radius:10px;">` : "💼";

            const element = document.getElementById('receiptTemplate');
            element.style.display = 'block';
            
            html2pdf().set({ 
                margin: 10, 
                filename: `وصل_راتب_${e.name}.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2 }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            }).from(element).save().then(() => {
                element.style.display = 'none';
                showToast("تم توليد وصل الراتب", "s");
            });
        }

        // دالة توليد PDF محسنة
        async function generateEnhancedPDF() {
            if (!requireEmployee()) return;
            
            const e = db.emps[curId];
            
            const reportData = {
                companyName: db.config.name,
                employeeName: e.name,
                date: new Date().toLocaleDateString('ar-EG'),
                period: new Date().toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' }),
                
                workingHours: calculateWorkingHours(e),
                overtime: calculateOvertime(e),
                bonuses: calculateBonuses(e),
                deductions: calculateDeductions(e),
                loans: calculateLoans(e),
                
                grossSalary: calculateGrossSalary(e),
                netSalary: calculateNetSalary(e)
            };
            
            const reportHTML = generateReportHTML(reportData);
            
            const element = document.createElement('div');
            element.innerHTML = reportHTML;
            element.style.direction = 'rtl';
            element.style.padding = '20px';
            element.style.background = 'white';
            element.style.color = '#333';
            
            const opt = {
                margin: [15, 15, 15, 15],
                filename: `تقرير_راتب_${e.name}_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
            showToast("جاري إنشاء التقرير المحسن...", "w");
        }

        // دوال مساعدة للحسابات
        function calculateWorkingHours(employee) {
            return employee.logs?.reduce((total, log) => {
                return total + (log.isPaid ? 0 : log.m / 60);
            }, 0) || 0;
        }

        function calculateOvertime(employee) {
            return employee.logs?.reduce((total, log) => {
                const hours = log.m / 60;
                return total + (hours > 8 ? hours - 8 : 0);
            }, 0) || 0;
        }

        function calculateBonuses(employee) {
            return employee.finance?.reduce((total, f) => {
                return total + (f.isPaid ? 0 : (f.amount > 0 ? f.amount : 0));
            }, 0) || 0;
        }

        function calculateDeductions(employee) {
            return employee.finance?.reduce((total, f) => {
                return total + (f.isPaid ? 0 : (f.amount < 0 ? Math.abs(f.amount) : 0));
            }, 0) || 0;
        }

        function calculateLoans(employee) {
            return employee.debts?.reduce((total, d) => {
                return total + (d.remaining || 0);
            }, 0) || 0;
        }

        function calculateGrossSalary(employee) {
            const hours = calculateWorkingHours(employee);
            return hours * (parseFloat(employee.rate) || 0);
        }

        function calculateNetSalary(employee) {
            const gross = calculateGrossSalary(employee);
            const bonuses = calculateBonuses(employee);
            const deductions = calculateDeductions(employee);
            const loans = calculateLoans(employee);
            
            return gross + bonuses - deductions - loans;
        }

        function generateReportHTML(data) {
            return `
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Arial; margin: 0; padding: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #3b82f6; padding-bottom: 15px; margin-bottom: 20px; }
                        .logo { width: 80px; height: 80px; margin: 0 auto 10px; background: #f0f0f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
                        .company-name { font-size: 24px; font-weight: bold; color: #1e293b; margin: 5px 0; }
                        .report-title { font-size: 18px; color: #64748b; margin-bottom: 10px; }
                        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
                        .info-item { background: #f8fafc; padding: 10px; border-radius: 8px; }
                        .info-label { font-size: 12px; color: #64748b; }
                        .info-value { font-size: 16px; font-weight: bold; color: #1e293b; }
                        .summary-card { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 20px; border-radius: 12px; margin: 20px 0; }
                        .summary-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
                        .summary-total { font-size: 20px; font-weight: bold; border-top: 2px solid rgba(255,255,255,0.3); margin-top: 8px; padding-top: 8px; }
                        .details-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        .details-table th { background: #f1f5f9; padding: 8px; font-size: 13px; }
                        .details-table td { padding: 8px; border-bottom: 1px solid #e2e8f0; }
                        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #64748b; border-top: 1px solid #e2e8f0; padding-top: 15px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">💼</div>
                        <div class="company-name">${data.companyName}</div>
                        <div class="report-title">كشف راتب شهر ${data.period}</div>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">اسم الموظف</div>
                            <div class="info-value">${data.employeeName}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">تاريخ الإصدار</div>
                            <div class="info-value">${data.date}</div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-item">
                            <span>إجمالي ساعات العمل</span>
                            <span>${data.workingHours.toFixed(1)} ساعة</span>
                        </div>
                        <div class="summary-item">
                            <span>ساعات إضافية</span>
                            <span>${data.overtime.toFixed(1)} ساعة</span>
                        </div>
                        <div class="summary-item">
                            <span>المكافآت</span>
                            <span>+ ${data.bonuses.toLocaleString()} د.ع</span>
                        </div>
                        <div class="summary-item">
                            <span>الاستقطاعات</span>
                            <span>- ${data.deductions.toLocaleString()} د.ع</span>
                        </div>
                        <div class="summary-item">
                            <span>السلف المتبقية</span>
                            <span>- ${data.loans.toLocaleString()} د.ع</span>
                        </div>
                        <div class="summary-total summary-item">
                            <span>صافي الراتب</span>
                            <span>${data.netSalary.toLocaleString()} د.ع</span>
                        </div>
                    </div>
                    
                    <table class="details-table">
                        <thead>
                            <tr>
                                <th>البيان</th>
                                <th>المبلغ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>الراتب الأساسي (${data.workingHours.toFixed(1)} ساعة)</td>
                                <td>${data.grossSalary.toLocaleString()} د.ع</td>
                            </tr>
                            ${data.bonuses > 0 ? `
                            <tr>
                                <td>المكافآت</td>
                                <td style="color: #10b981;">+ ${data.bonuses.toLocaleString()} د.ع</td>
                            </tr>
                            ` : ''}
                            ${data.deductions > 0 ? `
                            <tr>
                                <td>الاستقطاعات</td>
                                <td style="color: #ef4444;">- ${data.deductions.toLocaleString()} د.ع</td>
                            </tr>
                            ` : ''}
                            ${data.loans > 0 ? `
                            <tr>
                                <td>السلف المتبقية</td>
                                <td style="color: #f59e0b;">- ${data.loans.toLocaleString()} د.ع</td>
                            </tr>
                            ` : ''}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>تم إنشاء هذا التقرير بواسطة نظام الإدارة المتكامل 2026</p>
                        <p>توقيع المدير المالي: ______________________</p>
                    </div>
                </body>
                </html>
            `;
        }

        function sendWhatsApp() {
            window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(lastSettleMsg));
        }

        function exportToExcel() {
            if (!requireEmployee()) return;
            
            const e = db.emps[curId];
            let rows = [["التاريخ", "المدة (دقائق)", "النوع", "ملاحظات"]];
            
            if (e.logs) {
                e.logs.forEach(l => { 
                    if (!l.isPaid) rows.push([l.d, l.m, l.type, ""]); 
                });
            }
            
            if (e.finance) {
                e.finance.forEach(f => { 
                    if (!f.isPaid) rows.push([f.date, "", f.amount > 0 ? "مكافأة" : "استقطاع", f.reason]); 
                });
            }
            
            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, `كشف_${e.name}.xlsx`);
            showToast("تم تصدير الكشف", "s");
        }

        // دالة استيراد الإكسل المحسنة
        function parseTimeString(timeStr) {
            if (!timeStr) return null;
            
            try {
                if (typeof timeStr === 'number') {
                    return new Date((timeStr - 25569) * 86400 * 1000);
                }
                
                const str = String(timeStr).trim();
                
                const patterns = [
                    /(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(ص|م|صباحاً|مساءً)?/i,
                    /(\d{1,2})\s*[:\-]\s*(\d{2})/,
                    /(\d{1,2})\s*(ص|م)/i
                ];
                
                for (const pattern of patterns) {
                    const match = str.match(pattern);
                    if (match) {
                        let hours = parseInt(match[1]);
                        const minutes = parseInt(match[2]) || 0;
                        
                        if (match[3] && match[3].match(/م|مساءً/i) && hours < 12) {
                            hours += 12;
                        }
                        
                        return new Date(2000, 0, 1, hours, minutes);
                    }
                }
                
                return null;
            } catch (error) {
                console.error('خطأ في تحويل الوقت:', error);
                return null;
            }
        }

        function readExcel(inp) {
            if (!requireEmployee()) {
                inp.value = '';
                return;
            }

            if (!inp.files || inp.files.length === 0) {
                showToast("الرجاء اختيار ملف", "d");
                return;
            }

            let r = new FileReader();
            
            r.onload = e => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        showToast("الملف لا يحتوي على جداول", "d");
                        inp.value = '';
                        return;
                    }
                    
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    if (rows.length < 2) {
                        showToast("الملف لا يحتوي على بيانات كافية", "d");
                        inp.value = '';
                        return;
                    }

                    const headers = rows[0].map(h => String(h || '').trim());
                    let inCol = -1, outCol = -1;
                    
                    headers.forEach((header, index) => {
                        const headerStr = header.toLowerCase();
                        if (headerStr.includes('دخول') || headerStr.includes('in') || headerStr.includes('entry') || headerStr.includes('start')) {
                            inCol = index;
                        }
                        if (headerStr.includes('خروج') || headerStr.includes('out') || headerStr.includes('exit') || headerStr.includes('end')) {
                            outCol = index;
                        }
                    });

                    if (inCol === -1 || outCol === -1) {
                        showToast(`لم يتم العثور على عمودي الدخول والخروج`, "d");
                        inp.value = '';
                        return;
                    }

                    let count = 0;
                    let errors = 0;
                    
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row || row.length === 0) continue;
                        
                        if (row.length <= inCol || row.length <= outCol) continue;
                        
                        const inTime = row[inCol];
                        const outTime = row[outCol];
                        
                        if (inTime && outTime) {
                            try {
                                let inDate = parseTimeString(inTime);
                                let outDate = parseTimeString(outTime);
                                
                                if (inDate && outDate && !isNaN(inDate) && !isNaN(outDate)) {
                                    const diff = (outDate - inDate) / 60000;
                                    
                                    if (diff > 0 && diff < 1440) {
                                        if (!db.emps[curId].logs) db.emps[curId].logs = [];
                                        db.emps[curId].logs.unshift({ 
                                            m: diff, 
                                            d: new Date().toLocaleDateString('ar-EG'), 
                                            type: 'إكسل', 
                                            isPaid: false 
                                        });
                                        count++;
                                    } else {
                                        errors++;
                                    }
                                } else {
                                    errors++;
                                }
                            } catch (err) {
                                errors++;
                            }
                        }
                    }
                    
                    if (count > 0) {
                        saveDataToFirestore();
                        drawLogs();
                        calculateTotalSalary();
                        showToast(`تم استيراد ${count} سجل بنجاح ${errors > 0 ? `(تخطي ${errors} سجل غير صالح)` : ''}`, "s");
                    } else {
                        if (errors > 0) {
                            showToast(`لم يتم استيراد أي سجلات. ${errors} سجل غير صالح. تأكد من تنسيق الأوقات`, "d");
                        } else {
                            showToast("لم يتم العثور على سجلات صالحة للاستيراد", "d");
                        }
                    }
                    
                } catch (error) {
                    console.error("خطأ في قراءة الملف:", error);
                    showToast("خطأ في قراءة الملف: " + error.message, "d");
                }
                
                inp.value = '';
            };
            
            r.onerror = () => {
                showToast("خطأ في قراءة الملف", "d");
                inp.value = '';
            };
            
            r.readAsArrayBuffer(inp.files[0]);
        }

        function backupData() {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([JSON.stringify(db, null, 2)], { type:"application/json" }));
            a.download = `نسخة_احتياطية_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            showToast("تم إنشاء النسخة الاحتياطية", "s");
        }

        function restoreData(i) {
            if (!i.files || i.files.length === 0) return;
            
            let r = new FileReader();
            
            r.onload = async e => {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    
                    if (!restoredData.emps || !restoredData.config) {
                        showToast("ملف الاسترجاع غير صالح", "d");
                        return;
                    }
                    
                    db = restoredData;
                    await saveDataToFirestore();
                    showToast("تم استرجاع البيانات بنجاح", "s");
                    setTimeout(() => location.reload(), 1500);
                } catch (error) {
                    console.error("خطأ في استرجاع البيانات:", error);
                    showToast("خطأ في ملف الاسترجاع", "d");
                }
            };
            
            r.readAsText(i.files[0]);
        }

        function updateCharts() {
            try {
                if (attendanceChart && typeof attendanceChart.destroy === 'function') attendanceChart.destroy();
                if (financeChart && typeof financeChart.destroy === 'function') financeChart.destroy();
                if (monthlyChart && typeof monthlyChart.destroy === 'function') monthlyChart.destroy();
                if (debtChart && typeof debtChart.destroy === 'function') debtChart.destroy();
            } catch (error) {
                console.log("خطأ في تدمير الرسم البياني القديم:", error);
            }

            let empNames = [], workDays = [], totalFinanceOut = [], totalDebts = [], monthData = {};

            for (let id in db.emps) {
                let e = db.emps[id];
                empNames.push(e.name);
                
                let days = e.logs ? [...new Set(e.logs.map(l => l.d))].length : 0;
                workDays.push(days);
                
                let dSum = 0; 
                if (e.debts) e.debts.forEach(d => dSum += d.remaining); 
                totalDebts.push(dSum);
                
                let out = 0; 
                if (e.finance) e.finance.forEach(f => { if (f.amount < 0) out += Math.abs(f.amount); }); 
                totalFinanceOut.push(out);
                
                if (e.archive) {
                    e.archive.forEach(item => { 
                        let month = item.date.split('/')[1] || "0"; 
                        monthData[month] = (monthData[month] || 0) + item.amount; 
                    });
                }
            }

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { rtl: true }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: { font: { size: 10 } }
                    },
                    x: { 
                        ticks: { 
                            font: { size: 9, weight: '500' },
                            maxRotation: 30,
                            minRotation: 20
                        }
                    }
                },
                layout: {
                    padding: { top: 5, bottom: 5, left: 5, right: 5 }
                }
            };

            const attendanceCanvas = document.getElementById('attendanceChart');
            if (attendanceCanvas) {
                attendanceCanvas.style.height = '100%';
                attendanceCanvas.style.width = '100%';
                attendanceChart = new Chart(attendanceCanvas.getContext('2d'), { 
                    type: 'bar', 
                    data: { 
                        labels: empNames, 
                        datasets: [{ 
                            label: 'أيام الحضور', 
                            data: workDays, 
                            backgroundColor: '#3b82f6', 
                            borderRadius: 6 
                        }] 
                    }, 
                    options: { ...chartOptions, indexAxis: 'y' }
                });
            }

            const financeCanvas = document.getElementById('financeChart');
            if (financeCanvas) {
                financeCanvas.style.height = '100%';
                financeCanvas.style.width = '100%';
                financeChart = new Chart(financeCanvas.getContext('2d'), { 
                    type: 'line', 
                    data: { 
                        labels: empNames, 
                        datasets: [{ 
                            label: 'إجمالي الاستقطاعات', 
                            data: totalFinanceOut, 
                            borderColor: '#ef4444', 
                            backgroundColor: 'rgba(239,68,68,0.1)', 
                            tension: 0.3 
                        }] 
                    }, 
                    options: chartOptions
                });
            }

            const monthlyCanvas = document.getElementById('monthlyChart');
            if (monthlyCanvas) {
                monthlyCanvas.style.height = '100%';
                monthlyCanvas.style.width = '100%';
                monthlyChart = new Chart(monthlyCanvas.getContext('2d'), { 
                    type: 'bar', 
                    data: { 
                        labels: Object.keys(monthData).map(m => `شهر ${m}`), 
                        datasets: [{ 
                            label: 'إجمالي الرواتب المصروفة', 
                            data: Object.values(monthData), 
                            backgroundColor: '#10b981', 
                            borderRadius: 6 
                        }] 
                    }, 
                    options: chartOptions
                });
            }

            const debtCanvas = document.getElementById('debtChart');
            if (debtCanvas) {
                debtCanvas.style.height = '100%';
                debtCanvas.style.width = '100%';
                debtChart = new Chart(debtCanvas.getContext('2d'), { 
                    type: 'doughnut', 
                    data: { 
                        labels: empNames, 
                        datasets: [{ 
                            data: totalDebts, 
                            backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899'], 
                            borderWidth: 0 
                        }] 
                    }, 
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'bottom', 
                                rtl: true, 
                                labels: { 
                                    font: { size: 9 }, 
                                    boxWidth: 10 
                                } 
                            },
                            tooltip: { rtl: true }
                        }
                    }
                });
            }
        }

        function drawArchive() {
            if (!requireEmployee()) return;
            
            let e = db.emps[curId];
            if (!e || !e.archive) return;
            
            let search = document.getElementById('archiveSearch').value.toLowerCase();
            let h = "";
            
            e.archive.forEach(item => {
                if (!search || item.date.includes(search)) {
                    h += `<div style="background:var(--inp-bg); padding:10px; border-radius:12px; margin-bottom:5px; display:flex; justify-content:space-between;">
                        <span>📅 ${item.date}</span>
                        <span style="color:var(--s); font-weight:bold;">💰 ${item.amount} د.ع</span>
                    </div>`;
                }
            });
            
            document.getElementById('archiveBox').innerHTML = h || "<p style='color:#94a3b8; text-align:center;'>لا يوجد أرشيف</p>";
        }

        function changeMyPassword() {
            if (!requireEmployee()) return;
            
            let currentPass = document.getElementById('currentPassInp').value;
            let newPass = document.getElementById('newPassInp').value;
            
            if (!currentPass || !newPass) {
                showToast("الرجاء إدخال كلمة المرور الحالية والجديدة", "d");
                return;
            }
            
            if (newPass.length < 6) {
                showToast("كلمة المرور الجديدة يجب أن تكون 6 أحرف على الأقل", "d");
                return;
            }
            
            const user = auth.currentUser;
            const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPass);
            
            user.reauthenticateWithCredential(credential).then(() => {
                user.updatePassword(newPass).then(() => {
                    showToast("تم تغيير كلمة المرور بنجاح", "s");
                    document.getElementById('currentPassInp').value = '';
                    document.getElementById('newPassInp').value = '';
                }).catch(error => {
                    console.error("خطأ في تغيير كلمة المرور:", error);
                    showToast("خطأ: " + error.message, "d");
                });
            }).catch(error => {
                console.error("خطأ في إعادة المصادقة:", error);
                showToast("كلمة المرور الحالية غير صحيحة", "d");
            });
        }

        function changeAdminPassword() {
            if (!requireAdmin()) return;
            
            let currentPass = document.getElementById('currentAdminPass').value;
            let newPass = document.getElementById('newAdminPass').value;
            
            if (!currentPass || !newPass) {
                showToast("الرجاء إدخال كلمة المرور الحالية والجديدة", "d");
                return;
            }
            
            if (newPass.length < 6) {
                showToast("كلمة المرور الجديدة يجب أن تكون 6 أحرف على الأقل", "d");
                return;
            }
            
            const user = auth.currentUser;
            const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPass);
            
            user.reauthenticateWithCredential(credential).then(() => {
                user.updatePassword(newPass).then(() => {
                    showToast("تم تغيير كلمة المرور بنجاح", "s");
                    document.getElementById('currentAdminPass').value = '';
                    document.getElementById('newAdminPass').value = '';
                }).catch(error => {
                    console.error("خطأ في تغيير كلمة المرور:", error);
                    showToast("خطأ: " + error.message, "d");
                });
            }).catch(error => {
                console.error("خطأ في إعادة المصادقة:", error);
                showToast("كلمة المرور الحالية غير صحيحة", "d");
            });
        }

        function updateCloudStatus(state) {
            const dot = document.getElementById("cloudDot");
            const text = document.getElementById("cloudText");
            dot.classList.remove("cloud-online", "cloud-offline", "cloud-syncing");
            
            if (state === "online") { 
                dot.classList.add("cloud-online"); 
                text.textContent = "متصل"; 
            } else if (state === "syncing") { 
                dot.classList.add("cloud-syncing"); 
                text.textContent = "جاري الرفع..."; 
            } else { 
                dot.classList.add("cloud-offline"); 
                text.textContent = "غير متصل"; 
            }
        }

        // ================================================
        // أحداث النافذة
        // ================================================
        window.addEventListener("online", () => updateCloudStatus("online"));
        window.addEventListener("offline", () => updateCloudStatus("offline"));

        document.addEventListener('DOMContentLoaded', () => {
            updateCloudStatus("offline");
            document.getElementById('firstAdminScreen').style.display = 'none';
            checkForExistingAdmin();
        });

        window.addEventListener('beforeunload', function(e) {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
                saveDataToFirestore();
            }
        });
    </script>
</body>
</html>